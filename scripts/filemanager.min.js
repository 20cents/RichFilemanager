!function(a){a.richFilemanagerPlugin=function(b,c){function d(b,c){return-1===z.indexOf(c)?!1:"folder"===b.type&&"replace"===c?!1:"folder"===b.type&&"select"===c?!1:"folder"===b.type&&"download"===c?v.security.allowFolderDownload===!0:"undefined"!=typeof b.attributes.capabilities?a.inArray(c,b.attributes.capabilities)>-1:!0}function e(){v.filetree.enabled&&(r.show(),o.splitter({sizeLeft:v.filetree.width,minLeft:v.filetree.minWidth,minRight:200}),C.treeModel.loadNodes(null,!1))}function f(){C.itemsModel.loadList(x)}function g(){return window.opener||window.parent&&window.self!==window.parent||window.tinyMCEPopup||E.param("field_name")||E.param("CKEditor")||E.param("ImperaviElementId")}function h(a){var b=!C.clipboardModel.enabled(),c={select:{name:w.action_select,className:"select"},download:{name:w.action_download,className:"download"},rename:{name:w.action_rename,className:"rename"},move:{name:w.action_move,className:"move"},replace:{name:w.action_replace,className:"replace"},separator1:"-----",copy:{name:w.clipboard_copy,className:"copy"},cut:{name:w.clipboard_cut,className:"cut"},"delete":{name:w.action_delete,className:"delete"}};return d(a,"download")||delete c.download,d(a,"select")&&g()||delete c.select,d(a,"rename")&&v.options.browseOnly!==!0||delete c.rename,d(a,"delete")&&v.options.browseOnly!==!0||delete c["delete"],d(a,"copy")&&v.options.browseOnly!==!0&&!b||delete c.copy,d(a,"move")&&v.options.browseOnly!==!0&&!b||(delete c.cut,delete c.move),delete c.replace,c}var i={baseUrl:".",config:{},callbacks:{beforeCreateImageUrl:function(a,b){return b},beforeCreatePreviewUrl:function(a,b){return b},beforeSelectItem:function(a,b){return b},afterSelectItem:function(a,b,c){}}},j=this,k=a(b),l=k.children(".fm-wrapper"),m=l.find(".fm-header"),n=m.find(".fm-uploader"),o=l.children(".fm-splitter"),p=l.children(".fm-footer"),q=o.children(".fm-fileinfo"),r=o.children(".fm-filetree"),s=q.find(".view-items"),t=q.find(".fm-preview-wrapper"),u=n.children(".fm-upload"),v=null,w=null,x="/",y=null,z=[],A=null,B=null,C=null,D=null,E=purl();(new Date).getTime();j.settings=a.extend(!0,i,c),j.log=function(b,c){var d=alertify,e=a.extend({},{reset:!0,delay:5e3,logMaxItems:5,logPosition:"bottom right",logContainerClass:"fm-log",parent:a(".fm-popup").is(":visible")?document.body:q[0],onClick:void 0,unique:!1,type:"log"},c);return e.logClass&&e.unique&&a(".fm-log").children("."+e.logClass).length>0?d:(e.reset&&d.reset(),e.parent&&d.parent(e.parent),d.logDelay(e.delay),d.logMaxItems(e.logMaxItems),d.logPosition(e.logPosition),d.logContainerClass(e.logContainerClass),d[e.type](b,e.onClick),d)},j.error=function(b,c){return j.log(b,a.extend({},{type:"error",delay:1e4},c))},j.warning=function(b,c){return j.log(b,a.extend({},{type:"warning",delay:1e4},c))},j.success=function(b,c){return j.log(b,a.extend({},{type:"success",delay:6e3},c))},j.alert=function(a){alertify.reset().dialogContainerClass("fm-popup").alert(a)},j.confirm=function(a){alertify.reset().dialogWidth(a.width).dialogPersistent(a.persistent).dialogContainerClass("fm-popup").confirm(a.message,a.okBtn,a.cancelBtn)},j.prompt=function(a){alertify.reset().dialogWidth(a.width).dialogPersistent(a.persistent).dialogContainerClass("fm-popup").theme(a.template).prompt(a.message,a.value||"",a.okBtn,a.cancelBtn)},j.dialog=function(a){alertify.reset().dialogWidth(a.width).dialogPersistent(a.persistent).dialogContainerClass("fm-popup").dialog(a.message,a.buttons)},j.setDimensions=function(){var b=l.outerHeight(!0)-l.height(),c=a(window).height()-m.height()-p.height()-b,d=o.width()-o.children(".splitter-bar-vertical").outerWidth()-r.outerWidth();o.height(c),q.width(d)};var F=function(){var b=a.Deferred();b.then(function(){return G()}).then(function(a,b){return H()}).then(function(){return I()}).then(function(){return J()}).then(function(){K(function(){L()})}),b.resolve()},G=function(){return a.when(P("default"),P("user")).done(function(b,c){var d=b[0],e=c[0];if(void 0!==e&&null!==e&&delete e.version,v=a.extend({},d,e),v.api.connectorUrl)y=v.api.connectorUrl;else{var f=location.origin+location.pathname,g="connectors/"+v.api.lang+"/filemanager."+v.api.lang;da(f).length>0&&(f=f.substring(0,f.lastIndexOf("/")+1)),y=f+g}})},H=function(){return a.ajax({type:"GET",url:pa({mode:"initiate"}),dataType:"json"}).done(function(b){if(b.data){var c=b.data.attributes.config;a.each(c,function(b,c){a.each(c,function(a,c){"undefined"!==v[b]&&"undefined"!==v[b][a]&&(v[b][a]=c)})})}W(b)}).fail(function(){j.error("Unable to perform initial request to server.")}).then(function(b){return b.errors?a.Deferred().reject():void 0})},I=function(){function b(a){return d+a+".json"}var c=E.param("langCode"),d=j.settings.baseUrl+"/languages/";return a.ajax().then(function(){return c?O(b(c)).done(function(){v.options.culture=c}).fail(function(){setTimeout(function(){j.error("Given language file ("+b(c)+") does not exist!")},500)}):void 0}).then(function(){return a.ajax({type:"GET",url:b(v.options.culture),dataType:"json"}).done(function(a){w=a})})},J=function(){return a.when(R("upload-container"),R("upload-item")).done(function(a,b){var c=a[0],d=b[0];l.append(c).append(d)})},K=function(a){var b=[],c=[];if(b.push("/themes/"+v.options.theme+"/styles/theme.css"),v.customScrollbar.enabled&&(b.push("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css"),b.push("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js")),b.push(a),Q(b),v.viewer.editable.enabled){var d=v.viewer.editable.theme;d&&"default"!==d&&c.push("/scripts/CodeMirror/theme/"+d+".css"),c.push("/scripts/CodeMirror/lib/codemirror.css"),c.push("/scripts/CodeMirror/lib/codemirror.js"),c.push("/scripts/CodeMirror/addon/selection/active-line.js"),c.push("/scripts/CodeMirror/addon/display/fullscreen.css"),c.push("/scripts/CodeMirror/addon/display/fullscreen.js")}v.viewer.markdownRenderer.enabled&&(c.push("/styles/fm-markdown.css"),c.push("/scripts/markdown-it/markdown-it.min.js"),c.push("/scripts/markdown-it/default.min.css"),c.push("/scripts/markdown-it/highlight.min.js"),c.push("/scripts/markdown-it/markdown-it-footnote.min.js"),c.push("/scripts/markdown-it/markdown-it-replace-link.min.js")),v.options.browseOnly||(c.push("/scripts/jQuery-File-Upload/js/vendor/jquery.ui.widget.js"),c.push("/scripts/jQuery-File-Upload/js/canvas-to-blob.min.js"),c.push("/scripts/jQuery-File-Upload/js/load-image.all.min.js"),c.push("/scripts/jQuery-File-Upload/js/jquery.iframe-transport.js"),c.push("/scripts/jQuery-File-Upload/js/jquery.fileupload.js"),c.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-process.js"),c.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-image.js"),c.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-validate.js"),v.upload.multiple&&c.push("/scripts/jQuery-File-Upload/css/dropzone.css")),v.options.charsLatinOnly&&c.push("/scripts/speakingurl/speakingurl.min.js"),c.length&&Q(c)},L=function(){z=v.options.capabilities||["upload","select","download","rename","copy","move","delete","replace"];var b=[];v.options.fileSorting&&(b=v.options.fileSorting.toLowerCase().split("_")),A=b[0]||"name",B=b[1]||"asc";var c=E.param("exclusiveFolder");c&&(x="/"+c+"/",x=ca(x));var d=E.param("expandedFolder");if(d&&(D=x+d+"/",D=ca(D)),C=new M,ko.applyBindings(C),ko.bindingHandlers.toggleNodeVisibility={init:function(b,c){var d=c();a(b).toggle(d.isExpanded())},update:function(b,c){var d=c();return d.isSliding()===!1?!1:(d.isExpanded()===!1&&a(b).slideDown(v.filetree.expandSpeed,function(){d.isSliding(!1),d.isExpanded(!0)}),void(d.isExpanded()===!0&&a(b).slideUp(v.filetree.expandSpeed,function(){d.isSliding(!1),d.isExpanded(!1)})))}},ko.bindingHandlers.draggableView={init:function(b,c,d){var e=c();"file"!==e.rdo.type&&"folder"!==e.rdo.type||a(b).draggable({distance:3,cursor:"pointer",refreshPositions:!1,helper:function(){var b,c=C.itemsModel.getSelected(),d="drag-helper-"+C.viewMode(),e=a("<div>",{"class":d});return b=c.length>1?a("#drag-helper-"+C.viewMode()+"-template").clone():a(this).clone(),e.append(b.html())},appendTo:v.customScrollbar.enabled?q.find(".view-items-wrapper").find(".mCustomScrollBox"):q,start:function(a,b){e.selected()||(C.itemsModel.unselectItems(!1),e.selected(!0))},drag:function(b,c){a(this).draggable("option","refreshPositions",C.itemsModel.isScrolling())}})}},ko.bindingHandlers.droppableView={init:function(b,c,d){function e(b,c){var d=a.grep(c,function(a,c){return a.id===b.id});return b.rdo.attributes.writable&&0===d.length}"folder"!==c().rdo.type&&"parent"!==c().rdo.type||a(b).droppable({enableExtendedEvents:!0,accept:function(a){var b=ko.dataFor(a[0]),c=b?b.rdo.type:null;return"file"===c||"folder"===c},over:function(b,c){var d=ko.dataFor(b.target),f=C.itemsModel.getSelected();e(d,f)?a(this).addClass("drop-hover"):c.helper.addClass("drop-restricted")},out:function(b,c){a(this).removeClass("drop-hover"),c.helper.removeClass("drop-restricted")},drop:function(b,c){var d=ko.dataFor(b.target),f=C.itemsModel.getSelected();return a(b.target).removeClass("drop-hover"),e(d,f)?void ua(f,function(a,b){return Ba(b.rdo,d.id)}):!1}})}},s.selectable({filter:"li:not(.directory-parent), tbody > tr:not(.directory-parent)",cancel:".directory-parent, thead",disabled:!v.manager.selection.enabled,appendTo:s,start:function(a,b){va(),C.itemsModel.isSelecting(!0)},stop:function(a,b){C.itemsModel.isSelecting(!1)},selected:function(a,b){var c=ko.dataFor(b.selected);c.selected(!0)},unselected:function(a,b){var c=ko.dataFor(b.unselected);c.selected(!1)}}),ko.bindingHandlers.draggableTree={init:function(b,c,d){var e=c();"file"!==e.rdo.type&&"folder"!==e.rdo.type||a(b).draggable({distance:3,cursor:"pointer",refreshPositions:!1,helper:function(){return a("<li>").append(a(this).clone())},appendTo:v.customScrollbar.enabled?r.find(".mCustomScrollBox"):r,drag:function(b,c){a(this).draggable("option","refreshPositions",C.treeModel.isScrolling())}})}},ko.bindingHandlers.droppableTree={init:function(b,c,d){"folder"!==c().rdo.type&&"parent"!==c().rdo.type||a(b).droppable({hoverClass:"drop-hover",accept:function(b){if(b.closest("ul").prev("a").is(a(this)))return!1;if(a.contains(b.parent()[0],this))return!1;var c=ko.dataFor(b[0]),d=c?c.rdo.type:null;return"file"===d||"folder"===d},drop:function(a,b){Ba(ko.dataFor(b.draggable[0]),ko.dataFor(a.target).id)}})}},q.contextMenu({selector:".view-items",zIndex:10,build:function(a,b){var c={createFolder:{name:w.create_folder,className:"create-folder"},paste:{name:w.clipboard_paste,className:"paste",disabled:function(a,b){return C.clipboardModel.isEmpty()}}};return C.clipboardModel.enabled()&&v.options.browseOnly!==!0||delete c.paste,{appendTo:".fm-container",items:c,reposition:!1,callback:function(a,b){switch(a){case"createFolder":C.headerModel.createFolder();break;case"paste":C.clipboardModel.paste()}}}}}),v.extras.extra_js)for(var g=0;g<v.extras.extra_js.length;g++)a.ajax({type:"GET",url:v.extras.extra_js[g],dataType:"script",async:v.extras.extra_js_async});E.param("CKEditorCleanUpFuncNum")&&(C.headerModel.closeButton(!0),C.headerModel.closeButtonOnClick=function(){parent.CKEDITOR.tools.callFunction(E.param("CKEditorCleanUpFuncNum"))}),a("#newfile").change(function(){a("#filepath").val(a(this).val().replace(/.+[\\\/]/,""))}),e(),f(),La(),v.customScrollbar.enabled&&(r.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onScrollStart:function(){C.treeModel.isScrolling(!0)},onScroll:function(){C.treeModel.isScrolling(!1)}},axis:"yx"}),t.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".fm-preview-viewer"}}),q.find(".view-items-wrapper").mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".grid, .list"},callbacks:{onScrollStart:function(){C.itemsModel.continiousSelection()||(this.yStartPosition=this.mcs.top,this.yStartTime=(new Date).getTime()),C.itemsModel.isScrolling(!0)},onScroll:function(){C.itemsModel.isScrolling(!1)},whileScrolling:function(){if(v.manager.selection.enabled){var a=(new Date).getTime()-this.yStartTime;!C.itemsModel.continiousSelection()&&a>400&&(this.yStartPosition=this.mcs.top),C.itemsModel.isSelecting()&&C.itemsModel.continiousSelection(!0);var b=Math.abs(this.mcs.top)-Math.abs(this.yStartPosition);s.selectable("repositionCssHelper",b,0)}}},axis:"y",alwaysShowScrollbar:0}));var h=document.documentElement;if(h.setAttribute("data-useragent",navigator.userAgent),v.options.logger){(new Date).getTime()}var i=k.find(".fm-loading-wrap");i.fadeOut(800,function(){j.setDimensions()}),j.setDimensions()},M=function(){var b=this;this.config=ko.observable(v),this.lg=ko.observable(w),this.localizeGUI=ko.observable(v.options.localizeGUI),this.loadingView=ko.observable(!0),this.previewFile=ko.observable(!1),this.viewMode=ko.observable(v.options.defaultViewMode),this.currentPath=ko.observable(x),this.browseOnly=ko.observable(v.options.browseOnly),this.previewModel=ko.observable(null),this.previewFile.subscribe(function(a){a||b.previewModel.closeEditor()}),this.addItem=function(a,b){var c=C.treeModel.findByParam("id",b);if(c){var d=C.treeModel.createNode(a);C.treeModel.addNodes(c,d)}C.currentPath()===b&&C.itemsModel.addNew(a)},this.removeItem=function(a){var b=C.treeModel.findByParam("id",a.id);b&&b.remove();var c=C.itemsModel.findByParam("id",a.id);c&&c.remove()};var c=function(){var a=this;this.rdo=ko.observable({}),this.cdo=ko.observable({}),this.viewer={type:ko.observable("default"),isEditable:ko.observable(!1),url:ko.observable(null),options:ko.observable({}),content:ko.observable(null),codeMirror:ko.observable(null)},this.renderer=new p,this.editor=new q,this.rdo.subscribe(function(b){a.cdo({isFolder:"folder"===b.type,sizeFormatted:U(b.attributes.size),dimensions:b.attributes.width?b.attributes.width+"x"+b.attributes.height:null})}),this.editor.content.subscribe(function(b){a.renderer.render(b)}),this.applyObject=function(c){var d=c.attributes.name,e={interactive:!1},f={type:"default",url:null,options:{}};a.rdo(c),ia(d)&&(f.type="image",f.url=ra(c,!1)),ka(d)&&v.viewer.audio.enabled===!0&&(f.type="audio",f.url=qa(c,!0)),ja(d)&&v.viewer.video.enabled===!0&&(f.type="video",f.url=qa(c,!0),f.options={width:v.viewer.video.playerWidth,height:v.viewer.video.playerHeight}),la(d)&&v.viewer.opendoc.enabled===!0&&(f.type="opendoc",f.url=j.settings.baseUrl+"/scripts/ViewerJS/index.html#"+qa(c,!0),f.options={width:v.viewer.opendoc.readerWidth,height:v.viewer.opendoc.readerHeight}),ma(d)&&v.viewer.google.enabled===!0&&(f.type="google",f.url="http://docs.google.com/viewer?url="+encodeURIComponent(qa(c,!1))+"&embedded=true",f.options={width:v.viewer.google.readerWidth,height:v.viewer.google.readerHeight}),na(d)&&v.viewer.codeMirrorRenderer.enabled===!0&&(f.type="renderer"),oa(d)&&v.viewer.markdownRenderer.enabled===!0&&(f.type="renderer",e.interactive=!0),a.viewer.type(f.type),a.viewer.url(f.url),a.viewer.options(f.options),a.editor.interactive(e.interactive),"renderer"===f.type&&a.renderer.setRenderer(c),ha(d)&&v.viewer.editable.enabled===!0?(a.viewer.isEditable(!0),Fa(c).then(function(c){if(c.data){var d=c.data.attributes.content;b.previewFile(!0),a.viewer.content(d),a.renderer.render(d)}})):(a.viewer.isEditable(!1),b.previewFile(!0))},ZeroClipboard.config({swfPath:j.settings.baseUrl+"/scripts/zeroclipboard/dist/ZeroClipboard.swf"});var c=new ZeroClipboard(document.getElementById("fm-js-clipboard-copy"));c.on("ready",function(a){c.on("aftercopy",function(a){j.success(w.copied)})}),this.initiateEditor=function(b){a.editor.createInstance(a.rdo().attributes.extension,"fm-js-editor-content",{readOnly:!1,styleActiveLine:!0})},this.initiateRenderer=function(b){a.renderer.setContainer(b)},this.bindToolbar=function(b){d(a.rdo(),b)&&Ka(b,a.rdo())},this.previewIconClass=ko.pureComputed(function(){var b=[],c=["ico"];return"default"!==a.viewer.type()&&a.viewer.url()||(b.push("grid-icon"),this.cdo().isFolder===!0?(b.push("ico_folder"),c.push("folder"),this.rdo().attributes.readable||c.push("lock")):(b.push("ico_file"),this.rdo().attributes.readable?c.push("ext",this.rdo().attributes.extension):c.push("file","lock")),b.push(c.join("_"))),b.join(" ")},this),this.editFile=function(){var b=a.viewer.content();a.renderer.render(b),a.editor.render(b)},this.saveFile=function(){Ga(a.rdo())},this.closeEditor=function(){a.editor.enabled(!1),a.renderer.renderer()&&a.renderer.render(a.viewer.content())},this.buttonVisibility=function(b){switch(b){case"select":return d(a.rdo(),b)&&g();case"move":case"rename":case"delete":case"replace":return d(a.rdo(),b)&&v.options.browseOnly!==!0;case"download":return d(a.rdo(),b)}}},e=function(){var c=this;this.isScrolling=ko.observable(!1),this.selecledNode=ko.observable(null),this.treeData={id:x,level:ko.observable(-1),children:ko.observableArray([])},this.treeData.children.subscribe(function(a){c.arrangeNode(c.treeData)});var d=function(a){if(null!==D){a||(a=c.treeData);var b=c.findByFilter(function(a){return 0===D.indexOf(a.id)},a);b?(v.filetree.expandSpeed=10,c.loadNodes(b,!1)):(D=null,v.filetree.expandSpeed=200)}};this.findByParam=function(a,b,d){if(!d&&(d=c.treeData,d[a]===b))return d;var e=d.children();if(!e||0===e.length)return null;for(var f=0,g=e.length;g>f;f++){if(e[f][a]===b)return e[f];var h=c.findByParam(a,b,e[f]);if(h)return h}return null},this.findByFilter=function(a,b){if(!b&&(b=c.treeData,a(b)))return b;var d=b.children();if(!d||0===d.length)return null;for(var e=0,f=d.length;f>e;e++){if(a(d[e]))return d[e];var g=c.findByFilter(a,d[e]);if(g)return g}return null},this.loadNodes=function(b,e){var f=b?b.id:c.treeData.id;b&&b.isLoaded(!1);var g={mode:"getfolder",path:f};E.param("type")&&(g.type=E.param("type")),a.ajax({type:"GET",url:pa(g),dataType:"json",cache:!1,success:function(f){if(f.data){var g=[];a.each(f.data,function(a,b){var d=c.createNode(b);g.push(d)}),e&&b.children([]),c.addNodes(b,g),b&&(b.isLoaded(!0),c.expandNode(b)),d(b)}W(f)},error:V})},this.createNode=function(a){return new e(a)},this.addNodes=function(b,d){a.isArray(d)||(d=[d]),b||(b=c.treeData),v.filetree.foldersOnly&&(d=a.grep(d,function(a){return a.cdo.isFolder})),a.each(d,function(a,c){c.parentNode(b)});var e=b.children().concat(d);b.children(N(e))},this.expandNode=function(a){return a.isExpanded()===!1&&a.isLoaded()===!0?(a.isSliding(!0),!0):!1},this.collapseNode=function(a){return a.isExpanded()===!0?(a.isSliding(!0),!0):!1},this.toggleNode=function(a){c.collapseNode(a)||c.expandNode(a)},this.arrangeNode=function(b){var c=b.children().length;a.each(b.children(),function(a,d){d.level(b.level()+1),d.isFirstNode(0===a),d.isLastNode(a===c-1)})},this.nodeRendered=function(b,c){a(b[1]).contextMenu({selector:".file, .directory",zIndex:100,build:function(a,b){return{appendTo:".fm-container",items:h(c.rdo),callback:function(a,b){Ka(a,c.rdo)}}}})},this.actualizeNodeObject=function(b,d,e){var f=new RegExp("^"+d),g=b.rdo.id,h=g.replace(f,e);b.id=h,b.rdo.id=h,b.rdo.attributes.path=b.rdo.attributes.path.replace(new RegExp(g+"$"),h),b.children().length&&a.each(b.children(),function(a,b){c.actualizeNodeObject(b,d,e)})};var e=function(d){var e=this;this.id=d.id,this.rdo=d,this.cdo={isFolder:"folder"===d.type,dimensions:d.attributes.width?d.attributes.width+"x"+d.attributes.height:null,cssItemClass:"folder"===d.type?"directory":"file"},this.nodeTitle=ko.observable(d.attributes.name),this.children=ko.observableArray([]),this.parentNode=ko.observable(null),this.isSliding=ko.observable(!1),this.isLoading=ko.observable(!1),this.isLoaded=ko.observable(!1),this.isExpanded=ko.observable(!1),this.isSelected=ko.observable(!1),this.level=ko.observable(0),this.isFirstNode=ko.observable(!1),this.isLastNode=ko.observable(!1),this.nodeTitle.subscribe(function(a){e.rdo.attributes.name=a}),this.children.subscribe(function(a){c.arrangeNode(e)}),this.isLoaded.subscribe(function(a){e.isLoading(!a)}),this.switchNode=function(a){return a.cdo.isFolder?a.rdo.attributes.readable?void(a.isLoaded()?c.toggleNode(a):e.openNode(a)):(j.error(w.NOT_ALLOWED_SYSTEM),!1):!1},this.nodeClick=function(a){v.manager.dblClickOpen||e.openNode(a),null!==c.selecledNode()&&c.selecledNode().isSelected(!1),a.isSelected(!0),c.selecledNode(a)},this.nodeDblClick=function(a){v.manager.dblClickOpen&&e.openNode(a)},this.openNode=function(d){if("file"===d.rdo.type&&Ja(d.rdo),"folder"===d.rdo.type)if(!d.isLoaded()||d.isExpanded()&&v.filetree.reloadOnClick)c.loadNodes(d,!0),b.itemsModel.loadList(d.id);else{c.toggleNode(d),C.currentPath(d.id),C.breadcrumbsModel.splitCurrent();var e=[];a.each(d.children(),function(a,b){e.push(b.rdo)}),C.itemsModel.setList(e)}},this.remove=function(){e.parentNode().children.remove(e)},this.isRoot=function(){return e.level()===c.treeData.id},this.title=ko.pureComputed(function(){return v.options.showTitleAttr?this.rdo.id:null},this),this.iconClass=ko.pureComputed(function(){var a,b=["ico"];return this.cdo.isFolder===!0?(a="ico_folder",this.isLoading()===!0?b.push("loading"):(b.push("folder"),this.rdo.attributes.readable?(this.isExpanded()||!this.isExpanded()&&this.isSliding())&&b.push("open"):b.push("lock"))):(a="ico_file",this.rdo.attributes.readable?b.push("ext",this.rdo.attributes.extension):b.push("file","lock")),a+" "+b.join("_")},this),this.switcherClass=ko.pureComputed(function(){var a=[];if(v.filetree.showLine?0===this.level()&&this.isFirstNode()&&this.isLastNode()?a.push("root"):0==this.level()&&this.isFirstNode()?a.push("roots"):this.isLastNode()?a.push("bottom"):a.push("center"):a.push("noline"),this.cdo.isFolder){var b=this.isExpanded()||!this.isExpanded()&&this.isSliding();a.push(b?"open":"close")}else a.push("docu");return a.join("_")},this),this.clusterClass=ko.pureComputed(function(){return v.filetree.showLine&&!this.isLastNode()?"line":""},this)}},f=function(){function c(a){return v.manager.selection.enabled&&v.manager.selection.useCtrlKey&&a.ctrlKey===!0?!1:!v.manager.dblClickOpen||"click"!==a.type}var e=this;this.objects=ko.observableArray([]),this.objectsSize=ko.observable(0),this.objectsNumber=ko.observable(0),this.selectedNumber=ko.observable(0),this.listSortField=ko.observable(A),this.listSortOrder=ko.observable(B),this.isScrolling=ko.observable(!1),this.isSelecting=ko.observable(!1),this.continiousSelection=ko.observable(!1),this.descriptivePanel=new p,this.isSelecting.subscribe(function(a){a||e.continiousSelection(!1)}),this.createObject=function(a){return new f(a)},this.initiateRenderer=function(a){e.descriptivePanel.setContainer(a)},this.addNew=function(c){a.isArray(c)||(c=[c]),a.each(c,function(a,c){b.itemsModel.objects.push(e.createObject(c))}),b.itemsModel.sortObjects()},this.loadList=function(c){b.loadingView(!0);var d={mode:"getfolder",path:c};E.param("type")&&(d.type=E.param("type")),a.ajax({type:"GET",url:pa(d),dataType:"json",cache:!1,success:function(a){a.data&&(b.currentPath(c),b.breadcrumbsModel.splitCurrent(),b.itemsModel.setList(a.data)),W(a)},error:V})},this.setList=function(d){var f=[];if(!Y(b.currentPath())&&b.currentPath()!==x){var g=ga(b.currentPath()),h={id:g,rdo:{id:g,type:"parent",attributes:{readable:!0,writable:!0}}};h.open=function(a,b){c(b)&&e.loadList(h.id)},f.push(h)}e.descriptivePanel.content(null),a.each(d,function(a,b){v.manager.renderer.position&&b.attributes.name.toLowerCase()===v.manager.renderer.indexFile.toLowerCase()&&(e.descriptivePanel.setRenderer(b),Fa(e.descriptivePanel.rdo()).then(function(a){a.data&&e.descriptivePanel.render(a.data.attributes.content)})),f.push(e.createObject(b))}),b.itemsModel.objects(f),b.itemsModel.sortObjects(),b.loadingView(!1)},this.findByParam=function(a,c){return ko.utils.arrayFirst(b.itemsModel.objects(),function(b){return b[a]===c})},this.findByFilter=function(a,b){var c=!b,d=[],f=e.objects();if(!f||0===f.length)return null;for(var g=0,h=f.length;h>g;g++)if(a(f[g])){if(c)return f[g];d.push(f[g])}return c?null:d},this.sortObjects=function(){var a=N(e.objects());e.objects(a)},this.getSelected=function(){var a=e.findByFilter(function(a){return"parent"!==a.rdo.type&&a.selected()},!0);return e.selectedNumber(a.length),a},this.unselectItems=function(b){var c=v.manager.selection.enabled&&v.manager.selection.useCtrlKey&&b===!0;c||a.each(e.getSelected(),function(a,b){b.selected(!1)})},this.objects.subscribe(function(b){var c=0,d=0;a.each(b,function(a,b){"parent"!==b.rdo.type&&c++,"file"===b.rdo.type&&(d+=Number(b.rdo.attributes.size))}),e.objectsNumber(c),e.objectsSize(U(d)),s.contextMenu({selector:".file, .directory",zIndex:100,build:function(b,c){var d=ko.dataFor(b[0]);return d.selected()||(C.itemsModel.unselectItems(!1),d.selected(!0)),{appendTo:".fm-container",items:h(d.rdo),callback:function(b,c){var e=[];a.each(C.itemsModel.getSelected(),function(a,b){e.push(b.rdo)}),Ka(b,d.rdo,e)}}}})});var f=function(a){var b=v.viewer.image.thumbMaxWidth;a.attributes.width&&a.attributes.width<b&&(b=a.attributes.width),this.id=a.id,this.rdo=a,this.cdo={isFolder:"folder"===a.type,sizeFormatted:U(a.attributes.size),dimensions:a.attributes.width?a.attributes.width+"x"+a.attributes.height:null,cssItemClass:"folder"===a.type?"directory":"file",imageUrl:ra(a,!0),previewWidth:b},this.visible=ko.observable(!0),this.selected=ko.observable(!1),this.title=ko.pureComputed(function(){return v.options.showTitleAttr?this.rdo.id:null},this),this.itemClass=ko.pureComputed(function(){var a=[];return this.selected()&&v.manager.selection.enabled&&a.push("ui-selected"),this.cdo.cssItemClass+" "+a.join(" ")},this),this.listIconClass=ko.pureComputed(function(){var a,b=["ico"];return this.cdo.isFolder===!0?(a="ico_folder",b.push("folder"),this.rdo.attributes.readable||b.push("lock")):(a="ico_file",this.rdo.attributes.readable?b.push("ext",this.rdo.attributes.extension):b.push("file","lock")),a+" "+b.join("_")},this),this.gridIconClass=ko.pureComputed(function(){var a=[],b=["ico"];return this.cdo.imageUrl||(a.push("grid-icon"),this.cdo.isFolder===!0?(a.push("ico_folder"),b.push("folder"),this.rdo.attributes.readable||b.push("lock")):(a.push("ico_file"),this.rdo.attributes.readable?b.push("ext",this.rdo.attributes.extension):b.push("file","lock")),a.push(b.join("_"))),a.join(" ")},this),this.open=function(a,b){var f=this;e.unselectItems(b.ctrlKey),f.selected(!f.selected()),c(b)&&(v.options.quickSelect&&"file"===f.rdo.type&&d(f.rdo,"select")?wa(f.rdo):Ja(f.rdo))},this.remove=function(){e.objects.remove(this)}}},i=function(){var a=function(a){var c=this;this.column=ko.observable(a),this.order=ko.observable(b.itemsModel.listSortOrder()),this.sortClass=ko.pureComputed(function(){var a;return b.itemsModel.listSortField()===c.column()&&(a="sorted sorted-"+this.order()),a},this),this.sort=function(){var a="asc"===c.order(),d=b.itemsModel.listSortField()===c.column();c.order(d?a?"desc":"asc":b.itemsModel.listSortOrder()),b.itemsModel.listSortField(c.column()),b.itemsModel.listSortOrder(c.order()),b.itemsModel.sortObjects()}};this.thName=new a("name"),this.thType=new a("type"),this.thSize=new a("size"),this.thDimensions=new a("dimensions"),this.thModified=new a("modified")},k=function(){this.closeButton=ko.observable(!1),this.closeButtonOnClick=function(){},this.goHome=function(){b.previewFile(!1),b.itemsModel.loadList(x)},this.goParent=function(){var a=b.previewFile()?fa(b.previewModel.rdo().id):ga(b.currentPath());b.previewFile()&&b.previewFile(!1),a!==b.currentPath()&&b.itemsModel.loadList(a)},this.displayGrid=function(){b.viewMode("grid"),b.previewFile(!1)},this.displayList=function(){b.viewMode("list"),b.previewFile(!1)},this.createFolder=function(){var b=function(b,c){var d=c.getInputValue();return d?(d=S(d),void a.ajax({type:"GET",url:pa({mode:"addfolder",path:C.currentPath(),name:d}),dataType:"json",success:function(a){a.data&&(C.addItem(a.data,C.currentPath()),c.closeDialog(),v.options.showConfirmation&&j.success(w.successful_added_folder)),W(a)},error:V})):void j.error(w.no_foldername)};j.prompt({message:w.prompt_foldername,value:w.default_foldername,okBtn:{label:w.create_folder,autoClose:!1,click:b},cancelBtn:{label:w.cancel}})}},l=function(){this.files=ko.observable(null),this.folders=ko.observable(null),this.size=ko.observable(null),this.enabled=ko.observable(!1),this.doSummarize=function(){Ia()}},m=function(){var c=this;this.value=ko.observable(""),this.findAll=function(d,e){var f=200,g=!0;c.value(e.target.value),ta(function(){var d=g?c.value().toLowerCase():c.value();a.each(b.itemsModel.objects(),function(a,b){if("parent"!==b.rdo.type){var c=b.rdo.attributes.name;g&&(c=c.toLowerCase());var e=0===c.indexOf(d);b.visible(e)}})},f)},this.reset=function(d,e){c.value(""),a.each(b.itemsModel.objects(),function(a,b){b.visible(!0)})}},n=function(){function a(){c=[],d=null}var c=[],d=null,e=this,f=z.indexOf("copy")>-1||z.indexOf("move")>-1;this.enabled=ko.observable(b.config().options.clipboard&&f),this.copy=function(){e.hasCapability("copy")&&(d="copy",c=b.itemsModel.getSelected())},this.cut=function(){e.hasCapability("cut")&&(d="cut",c=b.itemsModel.getSelected())},this.paste=function(){if(e.hasCapability("paste")){if(null===d||0===c.length)return void j.warning(w.clipboard_empty);var f=b.currentPath();ua(c,function(a,b){return"cut"===d?Ba(b,f):"copy"===d?Aa(b,f):void 0},a)}},this.clear=function(){e.hasCapability("clear")&&(a(),j.success(w.clipboard_cleared))},this.isEmpty=function(){return 0===c.length},this.hasCapability=function(a){if(!e.enabled)return!1;switch(a){case"copy":return z.indexOf("copy")>-1;case"cut":return z.indexOf("move")>-1;default:return!0}}},o=function(){var a=this;this.items=ko.observableArray([]),this.add=function(b,d){a.items.push(new c(b,d))},this.splitCurrent=function(){var c=x,d=b.currentPath(),e=d.replace(new RegExp("^"+x),"").split("/");for(a.items([]),a.add(x,"");e.length>0;){var f=e.shift();f&&(c+=f+"/",a.add(c,f))}};var c=function(a,c){var d=this;this.path=a,this.label=c,this.isRoot=a===x,this.active=a===b.currentPath(),this.itemClass=function(){var a=["nav-item"];return d.isRoot&&a.push("root"),d.active&&a.push("active"),a.join(" ")},this["goto"]=function(a,c){a.active||b.itemsModel.loadList(a.path)}}},p=function(){var b,c=this;this.rdo=ko.observable({}),this.content=ko.observable(null),this.renderer=ko.observable(null),this.render=function(a){c.renderer().processContent(a)},this.setRenderer=function(a){c.rdo(a),oa(a.attributes.name)?c.renderer(new e):c.renderer(new d)},this.setContainer=function(d){a.each(d,function(){return a(this).hasClass("fm-renderer-container")?(b=a(this),!1):void 0}),setTimeout(function(){c.renderer().processDomElements()},0)};var d=function(){this.name="codeMirror";var a=new q;this.processContent=function(b){a.render(b),c.content(b)},this.processDomElements=function(){a.createInstance(c.rdo().attributes.extension,"fm-js-viewer-content",{readOnly:"nocursor",styleActiveLine:!1})}},e=function(){function d(){b.find("a").each(function(){var b=a(this).attr("href"),c=C.previewModel.editor;if(c.enabled()&&c.interactive())a(this).off("click"),a(this).on("click",function(){return!1});else{if(-1!=b.search("://")||aa(b,"mailto:"))return;oa(b)&&a(this).on("click",function(a){return Ha(b).then(function(a){a.data&&Ja(a.data)}),!1})}})}this.name="markdown";var e=window.markdownit({html:!0,linkify:!0,typographer:!0,highlight:function(a,b){if(b&&hljs.getLanguage(b))try{return'<pre class="highlight"><code>'+hljs.highlight(b,a,!0).value+"</code></pre>"}catch(c){}return'<pre class="highlight"><code>'+md.utils.escapeHtml(a)+"</code></pre>"},replaceLink:function(a,b){if(-1!=a.search("://")||aa(a,"mailto:"))return a;var d=aa(a,"/")?x:fa(c.rdo().id),e=d+$(a,"/");return oa(e)?e:pa({mode:"readfile",path:e})}}).use(window.markdownitReplaceLink);this.processContent=function(a){var b=e.render(a);c.content(b),d()},this.processDomElements=function(){}}},q=function(){function b(a){
d.enabled(!0),d.instance.setValue(a),d.instance.setOption("mode",d.mode()),d.instance.refresh()}function c(a){var b,c=[];v.viewer.editable.codeHighlight?("txt"===a&&(b="default"),"js"===a&&(c.push("/scripts/CodeMirror/mode/javascript/javascript.js"),b="javascript"),"css"===a&&(c.push("/scripts/CodeMirror/mode/css/css.js"),b="css"),"html"===a&&(c.push("/scripts/CodeMirror/mode/xml/xml.js"),b="text/html"),"xml"===a&&(c.push("/scripts/CodeMirror/mode/xml/xml.js"),b="application/xml"),"php"===a&&(c.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),c.push("/scripts/CodeMirror/mode/xml/xml.js"),c.push("/scripts/CodeMirror/mode/javascript/javascript.js"),c.push("/scripts/CodeMirror/mode/css/css.js"),c.push("/scripts/CodeMirror/mode/clike/clike.js"),c.push("/scripts/CodeMirror/mode/php/php.js"),b="application/x-httpd-php"),"sql"===a&&(c.push("/scripts/CodeMirror/mode/sql/sql.js"),b="text/x-mysql"),"md"===a&&(c.push("/scripts/CodeMirror/addon/mode/overlay.js"),c.push("/scripts/CodeMirror/mode/xml/xml.js"),c.push("/scripts/CodeMirror/mode/markdown/markdown.js"),c.push("/scripts/CodeMirror/mode/gfm/gfm.js"),c.push("/scripts/CodeMirror/mode/javascript/javascript.js"),c.push("/scripts/CodeMirror/mode/css/css.js"),c.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),c.push("/scripts/CodeMirror/mode/clike/clike.js"),c.push("/scripts/CodeMirror/mode/shell/shell.js"),c.push("/scripts/CodeMirror/mode/meta.js"),b="gfm"),"sh"===a&&(c.push("/scripts/CodeMirror/addon/mode/overlay.js"),c.push("/scripts/CodeMirror/mode/markdown/markdown.js"),c.push("/scripts/CodeMirror/mode/gfm/gfm.js"),c.push("/scripts/CodeMirror/mode/javascript/javascript.js"),c.push("/scripts/CodeMirror/mode/css/css.js"),c.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),c.push("/scripts/CodeMirror/mode/clike/clike.js"),c.push("/scripts/CodeMirror/mode/meta.js"),c.push("/scripts/CodeMirror/mode/shell/shell.js"),b="shell")):b="default",d.mode(b),c.length&&Q(c)}var d=this,e=null;this.instance=null,this.enabled=ko.observable(!1),this.content=ko.observable(null),this.mode=ko.observable(null),this.interactive=ko.observable(!1),this.render=function(a){d.instance?b(a):e=a},this.createInstance=function(f,g,h){var i,j={readOnly:"nocursor",styleActiveLine:!1,viewportMargin:1/0,lineNumbers:v.viewer.editable.lineNumbers,lineWrapping:v.viewer.editable.lineWrapping,theme:v.viewer.editable.theme,matchBrackets:v.viewer.editable.matchBrackets,extraKeys:{F11:function(a){a.setOption("fullScreen",!a.getOption("fullScreen"))},Esc:function(a){a.getOption("fullScreen")&&a.setOption("fullScreen",!1)}}};i=CodeMirror.fromTextArea(document.getElementById(g),a.extend({},j,h)),i.on("changes",function(a,b){d.content(a.getValue())}),d.instance=i,e&&b(e),c(f)}};this.treeModel=new e,this.itemsModel=new f,this.tableViewModel=new i,this.previewModel=new c,this.headerModel=new k,this.summaryModel=new l,this.searchModel=new m,this.clipboardModel=new n,this.breadcrumbsModel=new o},N=function(a){function b(a){var b,c=A;switch("list"===C.viewMode()&&(c=C.itemsModel.listSortField()),c){case"type":b=a.rdo.attributes.extension||"";break;case"size":b=a.rdo.attributes.size;break;case"modified":b=a.rdo.attributes.timestamp;break;case"dimensions":b=a.cdo.dimensions||"";break;default:b=a.rdo.attributes.name}return"string"==typeof b&&(f.cases||(b=b.toLowerCase()),b=b.replace(/\s+/g," ")),b}function c(a,b){for(var c=d(a.toString()),e=d(b.toString()),f=0;c[f]&&e[f];f++)if(c[f]!==e[f]){var g=Number(c[f]),h=Number(e[f]);return g==c[f]&&h==e[f]?g-h:c[f]>e[f]?1:-1}return c.length-e.length}function d(a){for(var b,c,d=[],e=0,f=-1,g=0;b=(c=a.charAt(e++)).charCodeAt(0);){var h=46==b||b>=48&&57>=b;h!==g&&(d[++f]="",g=h),d[f]+=c}return d}var e="list"===C.viewMode()?C.itemsModel.listSortOrder():B,f={natural:!0,order:"asc"===e?1:-1,cases:!1};a.sort(function(a,d){if("parent"===a.rdo.type||"parent"===d.rdo.type)return-1;var e,g=b(a),h=b(d);return e=g===h?0:void 0===g||void 0===h?0:f.natural&&(isNaN(g)||isNaN(h))?c(g,h):h>g?-1:g>h?1:0,e*=f.order});for(var g=[],h=a.length;h--;)"folder"===a[h].rdo.type&&(g.push(a[h]),a.splice(h,1));"top"!==v.options.folderPosition&&g.reverse();for(var i=0,j=g.length;j>i;i++)"top"===v.options.folderPosition?a.unshift(g[i]):a.push(g[i]);return a},O=function(b){return a.ajax({type:"HEAD",url:b})},P=function(b){var c=null;return b="undefined"==typeof b?"user":b,c="user"===b?E.param("config")?j.settings.baseUrl+"/config/"+E.param("config"):j.settings.baseUrl+"/config/filemanager.config.json":j.settings.baseUrl+"/config/filemanager.config.default.json",a.ajax({type:"GET",url:c,dataType:"json",cache:!1,error:function(a){j.error("Given config file ("+c+") does not exist!")}})},Q=function(a){for(var b=0,c=a.length;c>b;b++)"string"==typeof a[b]&&(a[b]=j.settings.baseUrl+a[b]);toast.apply(this,a)},R=function(b,c){return a.ajax({type:"GET",url:j.settings.baseUrl+"/scripts/templates/"+b+".html",error:V})},S=function(a,b){if(v.security.normalizeFilename){var c={" ":"_","'":"_","/":"","\\":""};a=a.replace(/[\s\S]/g,function(a){return c[a]||a})}return v.options.charsLatinOnly&&("undefined"==typeof b&&(b=[]),a=getSlug(a,{separator:"_",maintainCase:!0,custom:b}),a=a.replace(/[^_a-zA-Z0-9]/g,"")),a=a.replace(/[_]+/g,"_")},T=function(a){var b="";return-1!=a.lastIndexOf(".")?(b=S(a.substr(0,a.lastIndexOf("."))),b+="."+a.split(".").pop()):b=S(a),b},U=function(a,b){if(!a)return"";b=b||!1;for(var c=parseFloat(a),d=parseFloat(b?1e3:1024),e=0,f=[w.unit_bytes,w.unit_kb,w.unit_mb,w.unit_gb];;){if(d>c)return c=Math.round(100*c)/100,c+" "+f[e];c/=d,e+=1}},V=function(a){v.options.logger,j.error(w.ERROR_SERVER),j.error(a.responseText)},W=function(b){b.errors&&(v.options.logger,a.each(b.errors,function(a,b){j.error(b.title)}))},X=function(b){var c=da(b);return""===c&&v.security.allowNoExtension===!0?!0:"DISALLOW_ALL"==v.upload.policy&&-1!==a.inArray(c,v.upload.restrictions)?!0:"ALLOW_ALL"==v.upload.policy&&-1===a.inArray(c,v.upload.restrictions)},Y=function(a){return"/"!==a.charAt(a.length-1)},Z=function(a,b){var c=new RegExp("^"+b+"+|"+b+"+$","g");return a.replace(c,"")},$=function(a,b){var c=new RegExp("^"+b+"+","g");return a.replace(c,"")},_=function(a,b){var c=new RegExp(b+"+$","g");return a.replace(c,"")},aa=function(a,b,c){return c=c||0,a.substr(c,b.length)===b},ba=function(b){var c=[];return a.each(b.split("/"),function(a,b){c.push(encodeURIComponent(b))}),c.join("/")},ca=function(a){return a.replace(/\\/g,"/").replace(/\/+/g,"/")},da=function(a){return 1===a.split(".").length?"":a.split(".").pop().toLowerCase()},ea=function(a){return-1!==a.lastIndexOf(".")?a.substring(0,a.lastIndexOf(".")):a},fa=function(a){return a.lastIndexOf("/")!==a.length-1?a.substr(0,a.lastIndexOf("/")+1):a},ga=function(a){return a.split("/").reverse().slice(2).reverse().join("/")+"/"},ha=function(b){return-1!==a.inArray(da(b),v.viewer.editable.extensions)},ia=function(b){return-1!==a.inArray(da(b),v.viewer.image.extensions)},ja=function(b){return-1!==a.inArray(da(b),v.viewer.video.extensions)},ka=function(b){return-1!==a.inArray(da(b),v.viewer.audio.extensions)},la=function(b){return-1!==a.inArray(da(b),v.viewer.opendoc.extensions)},ma=function(b){return-1!==a.inArray(da(b),v.viewer.google.extensions)},na=function(b){return-1!==a.inArray(da(b),v.viewer.codeMirrorRenderer.extensions)},oa=function(b){return-1!==a.inArray(da(b),v.viewer.markdownRenderer.extensions)},pa=function(b){var c={time:(new Date).getTime()},d=a.extend({},b||{},c);return y+"?"+a.param(d)},qa=function(a,b){b=b||!1;var c,d=a.attributes.path;return v.viewer.absolutePath&&d?(b&&(d=ba(d)),c=sa(d)):c=pa({mode:"readfile",path:a.id}),c=j.settings.callbacks.beforeCreatePreviewUrl(a,c)},ra=function(a,b){var c;if(ia(a.id)&&a.attributes.readable&&(b&&v.viewer.image.showThumbs||!b&&v.viewer.image.enabled===!0)){if(v.viewer.absolutePath&&!b&&a.attributes.path)c=sa(ba(a.attributes.path));else{var d={path:a.id};"svg"===a.attributes.extension?d.mode="readfile":(d.mode="getimage",b&&(d.thumbnail="true")),c=pa(d)}c=j.settings.callbacks.beforeCreateImageUrl(a,c)}return c},sa=function(a){var b="string"==typeof v.viewer.previewUrl?v.viewer.previewUrl:location.origin;return Z(b,"/")+a+"?time="+(new Date).getTime()},ta=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}(),ua=function(b,c,d){var e=0,f=b.length,g=a.Deferred().resolve();a.each(b,function(a,b){g=g.then(function(){return c(a,b)}).then(function(a){a&&a.data&&e++})}),f>1&&g.then(function(){j.log(w.successful_processed.replace("%s",e).replace("%s",f))}),g.then(function(){"function"==typeof d&&d()})},va=function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var a=window.getSelection();a.removeAllRanges()}},wa=function(a){var b=null,c=qa(a,!0);if(c=j.settings.callbacks.beforeSelectItem(a,c),window.tinyMCEPopup){var d=tinyMCEPopup.getWindowArg("window");return d.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=c,"undefined"!=typeof d.ImageDialog&&(d.ImageDialog.getImageData&&d.ImageDialog.getImageData(),d.ImageDialog.showPreviewImage&&d.ImageDialog.showPreviewImage(c)),void tinyMCEPopup.close()}if(E.param("field_name")&&(parent.document.getElementById(E.param("field_name")).value=c,"undefined"!=typeof parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),"undefined"!=typeof parent.$.fn.colorbox&&parent.$.fn.colorbox.close()),E.param("ImperaviElementId"))if(window.opener);else{var e=E.param("ImperaviElementId"),f=parent.$("#"+e).redactor("core.getObject");f&&(f.modal.close(),f.buffer.set(),ia(a.attributes.name)?f.insert.html('<img src="'+c+'">'):f.insert.html('<a href="'+c+'">'+a.attributes.name+"</a>"))}if(E.param("CKEditor")&&(window.opener?window.opener.CKEDITOR.tools.callFunction(E.param("CKEditorFuncNum"),c):(parent.CKEDITOR.tools.callFunction(E.param("CKEditorFuncNum"),c),parent.CKEDITOR.tools.callFunction(E.param("CKEditorCleanUpFuncNum")))),window.opener&&"function"==typeof window.opener.SetUrl)if(a.attributes.width){var g=c,h=a.attributes.width,i=a.attributes.height;window.opener.SetUrl(g,h,i)}else window.opener.SetUrl(c);window.opener&&(b=window.opener),window.parent&&window.self!==window.parent&&(b=window.parent),b&&b.postMessage({source:"richfilemanager",preview_url:c},"*"),j.settings.callbacks.afterSelectItem(a,c,b)},xa=function(b){var c=function(c,d){var e=b.id,f=d.getInputValue();if(!f)return void j.error(w.new_filename);if(!v.security.allowChangeExtensions){f=T(f);var g=da(b.attributes.name);g.length>0&&(f=f+"."+g)}if(Y(e)&&!X(f)){var h="<p>"+w.INVALID_FILE_TYPE+"</p>";return"DISALLOW_ALL"==v.upload.policy&&(h+="<p>"+w.ALLOWED_FILE_TYPE+v.upload.restrictions.join(", ")+".</p>"),"ALLOW_ALL"==v.upload.policy&&(h+="<p>"+w.DISALLOWED_FILE_TYPE+v.upload.restrictions.join(", ")+".</p>"),a("#filepath").val(""),void j.error(h)}a.ajax({type:"GET",url:pa({mode:"rename",old:e,"new":f}),dataType:"json",success:function(a){if(a.data){var b=a.data,c=C.treeModel.findByParam("id",e);if(c&&("folder"===c.rdo.type&&(c.nodeTitle(b.attributes.name),C.treeModel.actualizeNodeObject(c,e,b.id)),"file"===c.rdo.type)){var f=c.parentNode(),g=C.treeModel.createNode(b);c.remove(),f&&C.treeModel.addNodes(f,g)}var h=C.itemsModel.findByParam("id",e);h&&("parent"===h.rdo.type?h.id=b.id:(h.remove(),C.itemsModel.addNew(b))),C.currentPath()===e&&C.itemsModel.loadList(b.id),C.previewFile()&&C.previewModel.rdo().id===e&&C.previewModel.applyObject(b),d.closeDialog(),v.options.showConfirmation&&j.success(w.successful_rename)}W(a)},error:V})};j.prompt({message:w.new_filename,value:v.security.allowChangeExtensions?b.attributes.name:ea(b.attributes.name),okBtn:{label:w.action_rename,autoClose:!1,click:c},cancelBtn:{label:w.cancel}})},ya=function(b){var c=a("#fm-js-preview-toolbar"),d=c.find(":file");"undefined"==typeof c.data("blueimpFileupload")&&c.fileupload({autoUpload:!0,dataType:"json",url:pa(),paramName:v.upload.paramName}).on("fileuploadadd",function(a,c){var d=c.files[0];return da(d.name)!=b.attributes.extension?(j.error(w.ERROR_REPLACING_FILE+" ."+b.attributes.extension),!1):void c.submit()}).on("fileuploadsubmit",function(a,c){c.formData={mode:"replace",path:b.id},u.addClass("loading").prop("disabled",!0),u.children("span").text(w.loading_data)}).on("fileuploadalways",function(a,b){u.removeData().removeClass("loading").prop("disabled",!1),u.children("span").text(w.action_upload);var c=b.result;if(c&&c.errors&&j.error(w.upload_failed+"<br>"+c.errors[0].title),c&&c.data){var d=c.data[0];C.removeItem(d),C.addItem(d,C.currentPath()),C.previewFile()&&C.previewModel.applyObject(d),v.options.showConfirmation&&j.success(w.successful_replace)}}).on("fileuploadchunkdone",function(a,b){var c=b.result;if(c.data&&c.data[0]){var d=c.data[0];C.removeItem(d),C.addItem(d,C.currentPath())}}).on("fileuploadfail",function(a,b){j.error(w.upload_failed)}),d.click()},za=function(a,b){var c=function(a,c){var d=c.getInputValue();return d?(d=_(d,"/")+"/",void b(d)):void j.error(w.prompt_foldername)},d=a.length,e=d>1?w.prompt_move_multiple.replace("%s",d):w.prompt_move;j.prompt({message:e,value:C.currentPath(),okBtn:{label:w.action_move,autoClose:!1,click:c},cancelBtn:{label:w.cancel},template:{dialogInput:'<input data-alertify-input type="text" value="" /><div class="prompt-info">'+w.help_move+"</div>"}})},Aa=function(b,c){return a.ajax({type:"GET",url:pa({mode:"copy",source:b.id,target:c}),dataType:"json",success:function(a){if(a.data){var b=a.data;C.addItem(b,c),alertify.clearDialogs(),v.options.showConfirmation&&j.success(w.successful_copied)}W(a)},error:V})},Ba=function(b,c){return a.ajax({type:"GET",url:pa({mode:"move",old:b.id,"new":c}),dataType:"json",success:function(a){if(a.data){var d=a.data;C.removeItem(b),C.addItem(d,c),C.currentPath()===b.id&&C.itemsModel.loadList(d.id),C.previewFile()&&C.previewModel.rdo().id===b.id&&C.previewFile(!1),alertify.clearDialogs(),v.options.showConfirmation&&j.success(w.successful_moved)}W(a)},error:V})},Ca=function(a,b){var c=a.length,d=c>1?w.confirm_delete_multiple.replace("%s",c):w.confirm_delete;j.confirm({message:d,okBtn:{label:w.yes,click:function(a,c){b()}},cancelBtn:{label:w.no}})},Da=function(b){return a.ajax({type:"GET",url:pa({mode:"delete",path:b}),dataType:"json",success:function(a){if(a.data){var b=a.data;C.removeItem(b),C.previewFile()&&C.previewModel.rdo().id===b.id&&C.previewFile(!1),v.options.showConfirmation&&j.success(w.successful_delete)}W(a)},error:V})},Ea=function(b){var c={mode:"download",path:b.id};return a.ajax({type:"GET",url:pa(c),dataType:"json",success:function(b){b.data&&a.fileDownload(pa(c)),W(b)},error:V})},Fa=function(b){return a.ajax({type:"GET",url:pa({mode:"editfile",path:b.id}),dataType:"json",success:function(a){W(a)},error:V})},Ga=function(b){a.ajax({type:"POST",url:pa(),dataType:"json",data:a("#fm-js-editor-form").serializeArray(),success:function(a){if(a.data){var b=a.data,c=C.previewModel,d=c.editor.content();c.rdo(b),c.viewer.content(d),c.closeEditor();var e=C.itemsModel.createObject(b),f=C.itemsModel.findByParam("id",b.id);C.itemsModel.objects.replace(f,e),C.itemsModel.descriptivePanel.rdo().id===b.id&&C.itemsModel.descriptivePanel.render(d),j.success(w.successful_edit)}W(a)},error:V})},Ha=function(b){return a.ajax({type:"GET",url:pa({mode:"getfile",path:b}),dataType:"json",success:function(a){W(a)},error:V})},Ia=function(){a.ajax({type:"GET",url:pa({mode:"summarize"}),dataType:"json",success:function(b){if(b.data){var c=b.data.attributes,d=U(c.size,!0);if(c.sizeLimit>0){var e=U(c.sizeLimit,!0),f=100*c.size/c.sizeLimit,g=Math.round(100*f)/100;d+=" ("+g+"%) "+w.of+" "+e}C.summaryModel.files(c.files),C.summaryModel.folders(c.folders),C.summaryModel.size(d),C.summaryModel.enabled(!0);var h=a("#summary-popup").clone().show();C.summaryModel.enabled(!1),j.alert(h[0].outerHTML)}W(b)},error:V})},Ja=function(a){return a.attributes.readable?("file"===a.type&&C.previewModel.applyObject(a),void("folder"!==a.type&&"parent"!==a.type||C.itemsModel.loadList(a.id))):(j.error(w.NOT_ALLOWED_SYSTEM),!1)},Ka=function(b,c,d){var e=d?d:[c];switch(b){case"select":wa(c);break;case"download":a.each(e,function(a,b){Ea(b)});break;case"rename":xa(c);break;case"replace":ya(c);break;case"move":za(e,function(a){ua(e,function(b,c){return Ba(c,a)})});break;case"delete":Ca(e,function(){ua(e,function(a,b){return Da(b.id)})});break;case"copy":C.clipboardModel.copy();break;case"cut":C.clipboardModel.cut()}},La=function(){return v.options.browseOnly?!1:void(v.upload.multiple?(a("#file-input-container").remove(),u.unbind().click(function(){if(-1===z.indexOf("upload"))return j.error(w.NOT_ALLOWED),!1;var b=null,c=C.currentPath(),d=tmpl("tmpl-fileupload-container",{folder:w.current_folder+c,info:w.upload_files_number_limit.replace("%s",v.upload.maxNumberOfFiles)+" "+w.upload_file_size_limit+U(v.upload.fileSizeLimit,!0),lang:w});"DISALLOW_ALL"==v.upload.policy&&(b=new RegExp("(\\.|\\/)("+v.upload.restrictions.join("|")+")$","i")),j.dialog({message:d,width:"auto",buttons:[{type:"ok",label:w.action_upload,autoClose:!1,click:function(a,b){f.children(".upload-item").length>0?f.find(".button-start").trigger("click"):j.error(w.upload_choose_file)}},{label:w.action_select,closeOnClick:!1,click:function(b,c){a("#fileupload",e).trigger("click")}},{type:"cancel",label:w.close}]});var e=a(".fm-fileupload-container"),f=a(".dropzone",e),g=a(".dropzone-wrapper",e),h=a("#total-progress",e).children();v.customScrollbar.enabled&&g.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onOverflowY:function(){g.find(".mCSB_container").css({"margin-right":g.find(".mCSB_scrollTools").width()})},onOverflowYNone:function(){g.find(".mCSB_container").css({"margin-right":"auto"})}},axis:"y"}),g.on("click",function(b){(b.target===this||a(b.target).parent()[0]===this||b.target===f[0]||a(b.target).parent().hasClass("default-message"))&&a("#fileupload",e).trigger("click")}),f.on("click",".button-start",function(b){var c=a(this),d=c.parent().parent(),e=d.data();e.submit(),c.remove()}),f.on("click",".button-abort",function(b){var c=a(this),d=c.parent().parent(),e=d.data(),f=e.files[0].context;e.abort(),f.find(".error-message").text(w.upload_aborted),f.addClass("aborted")}),f.on("click",".button-resume",function(b){function d(c){a.blueimp.fileupload.prototype.options.add.call(a("#fileupload")[0],b,c),c.submit()}var e=a(this),f=e.parent().parent(),g=f.data(),h=g.files[0];if(h.chunkUploaded){var i=c+h.serverName;Ha(i).then(function(a){a.data&&(g.uploadedBytes=Number(a.data.attributes.size),g.uploadedBytes||(h.chunkUploaded=void 0),d(g))})}else d(g)}),f.on("click",".button-remove",function(b){var d=a(this),e=d.parent().parent(),f=e.data(),g=f.files[0];g.chunkUploaded&&Da(c+g.serverName),d.closest(".upload-item").remove(),i()}),f.on("click",".button-info",function(b){var c=a(this),d=c.closest(".upload-item");if(d.hasClass("error")){var e=d.find(".error-message");j.error(e.text())}});var i=function(){f.children(".upload-item").length>0?f.addClass("started"):f.removeClass("started")};a("#fileupload",e).fileupload({autoUpload:!1,sequentialUploads:!0,dataType:"json",dropZone:f,maxChunkSize:v.upload.chunkSize,url:pa(),paramName:v.upload.paramName,singleFileUploads:!0,formData:{mode:"upload",path:c},maxNumberOfFiles:v.upload.maxNumberOfFiles,acceptFileTypes:b,maxFileSize:v.upload.fileSizeLimit,messages:{maxNumberOfFiles:w.upload_files_number_limit.replace("%s",v.upload.maxNumberOfFiles),acceptFileTypes:w.upload_file_type_invalid,maxFileSize:w.upload_file_too_big+" "+w.upload_file_size_limit+U(v.upload.fileSizeLimit,!0)},previewMaxHeight:120,previewMaxWidth:120,previewCrop:!0}).on("fileuploadadd",function(b,c){var d=f.children(".upload-item");a.each(c.files,function(b,e){if(d.length>=v.upload.maxNumberOfFiles)return j.error(w.upload_files_number_limit.replace("%s",v.upload.maxNumberOfFiles),{logClass:"fileuploadadd",unique:!0}),!1;e.formattedSize=U(e.size);var g=a(tmpl("tmpl-upload-item",{file:e,lang:w,imagesPath:j.settings.baseUrl+"/scripts/jQuery-File-Upload/img"}));e.context=g,g.find(".buttons").data(c),g.appendTo(f)}),i()}).on("fileuploadsend",function(b,c){a.each(c.files,function(a,b){var d=b.context;d.removeClass("added aborted error").addClass("process"),b.chunkUploaded&&c.total===c.uploadedBytes&&d.remove()})}).on("fileuploadfail",function(b,c){a.each(c.files,function(a,b){b.error=w.upload_failed;var c=b.context;c.removeClass("added process").addClass("error")})}).on("fileuploaddone",function(b,c){var d=c.result;a.each(c.files,function(a,b){var c=b.context;d&&d.errors?(c.removeClass("added process").addClass("error"),c.find(".error-message").text(d.errors[0].title),c.find(".button-start").remove()):c.remove()})}).on("fileuploadalways",function(b,c){var d=c.result;a.each(c.files,function(a,b){if(d&&d.data&&d.data[a]){var c=d.data[a];C.removeItem(c),C.addItem(c,C.currentPath())}});var e=f.children(".upload-item");0===e.filter(".added").length&&0===e.filter(".process").length&&(0===e.length&&(alertify.clearDialogs(),v.options.showConfirmation&&j.success(w.upload_successful_files)),e.filter(".error").length&&j.error(w.upload_partially+"<br>"+w.upload_failed_details)),i()}).on("fileuploadchunkdone",function(b,c){var d=c.result;a.each(c.files,function(a,b){if(d.data&&d.data[a]){var c=d.data[a];C.removeItem(c),C.addItem(c,C.currentPath()),b.serverName=c.attributes.name,b.chunkUploaded=1}})}).on("fileuploadprocessalways",function(b,c){a.each(c.files,function(a,b){var c=b.context;"undefined"!=typeof c&&(b.preview&&(c.find(".image").append(b.preview),c.find(".preview").removeClass("file-preview").addClass("image-preview")),b.error&&(c.removeClass("added process").addClass("error"),c.find(".error-message").text(b.error),c.find(".button-start").remove()))})}).on("fileuploadprogress",function(b,c){a.each(c.files,function(a,b){var d=b.context,e=parseInt(c.loaded/c.total*100,10);d.find(".progress-bar").css("width",e+"%")})}).on("fileuploadprogressall",function(a,b){var c=parseInt(b.loaded/b.total*100,10);h.css("width",c+"%")})})):(u.click(function(){if(-1===z.indexOf("upload"))return j.error(w.NOT_ALLOWED),!1;var b=a(this).data();a.isEmptyObject(b)?j.error(w.upload_choose_file):b.submit()}),n.fileupload({autoUpload:!1,dataType:"json",url:pa(),paramName:v.upload.paramName,maxChunkSize:v.upload.chunkSize}).on("fileuploadadd",function(a,b){u.data(b)}).on("fileuploadsubmit",function(a,b){b.formData={mode:"upload",path:C.currentPath()},u.addClass("loading").prop("disabled",!0),u.children("span").text(w.loading_data)}).on("fileuploadalways",function(b,c){a("#filepath").val(""),u.removeData().removeClass("loading").prop("disabled",!1),u.children("span").text(w.action_upload);var d=c.result;if(d&&d.errors&&j.error(w.upload_failed+"<br>"+d.errors[0].title),d&&d.data){var e=d.data[0];C.removeItem(e),C.addItem(e,C.currentPath()),v.options.showConfirmation&&j.success(w.upload_successful_file)}}).on("fileuploadchunkdone",function(a,b){var c=b.result;if(c.data&&c.data[0]){var d=c.data[0];C.removeItem(d),C.addItem(d,C.currentPath())}}).on("fileuploadfail",function(a,b){j.error(w.upload_failed)})))};F(),a(window).resize(j.setDimensions)}}(jQuery),$.fn.richFilemanager=function(a){return this.each(function(){if(void 0==$(this).data("richFilemanager")){var b=new $.richFilemanagerPlugin(this,a);$(this).data("richFilemanager",b)}})},window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));