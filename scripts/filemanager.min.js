!function(a){a.urlParam=function(a){var b=new RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);return b?b[1]:0},a.richFmPlugin=function(b,c){function d(b,c){return-1===x.indexOf(c)?!1:"folder"===b.type&&"replace"===c?!1:"folder"===b.type&&"select"===c?!1:"folder"===b.type&&"download"===c?s.security.allowFolderDownload===!0:"undefined"!=typeof b.attributes.capabilities?a.inArray(c,b.attributes.capabilities)>-1:!0}function e(b){var c={select:{name:t.select,className:"select"},download:{name:t.download,className:"download"},rename:{name:t.rename,className:"rename"},move:{name:t.move,className:"move"},replace:{name:t.replace,className:"replace"},separator1:"-----","delete":{name:t.del,className:"delete"}};return d(b,"download")||delete c.download,d(b,"rename")&&s.options.browseOnly!==!0||delete c.rename,d(b,"delete")&&s.options.browseOnly!==!0||delete c["delete"],d(b,"move")&&s.options.browseOnly!==!0||delete c.move,d(b,"select")&&(window.opener||window.tinyMCEPopup||a.urlParam("field_name"))||delete c.select,delete c.replace,c}var f={pluginPath:"."},g=this,h=a(b),i=h.children(".fm-wrapper"),j=i.find(".fm-header"),k=j.find(".fm-uploader"),l=i.children(".fm-splitter"),m=i.children(".fm-footer"),n=l.children(".fm-fileinfo"),o=l.children(".fm-filetree"),p=k.children(".fm-upload"),q=(n.find("#contents"),[]),r=[],s=null,t=null,u="/",v=null,w=null,x=[],y=null,z=null,A=null,B=null,C=null;(new Date).getTime();g.settings={},g.log=function(b,c){var d=alertify,e=a.extend({},{reset:!0,delay:5e3,logMaxItems:5,logPosition:"bottom right",logContainerClass:"fm-log",parent:a(".fm-popup").is(":visible")?document.body:n[0],onClick:void 0,unique:!1,type:"log"},c);return e.logClass&&e.unique&&a(".fm-log").children("."+e.logClass).length>0?d:(e.reset&&d.reset(),e.parent&&d.parent(e.parent),d.logDelay(e.delay),d.logMaxItems(e.logMaxItems),d.logPosition(e.logPosition),d.logContainerClass(e.logContainerClass),d[e.type](b,e.onClick),d)},g.error=function(b,c){return g.log(b,a.extend({},{type:"error",delay:1e4},c))},g.warning=function(b,c){return g.log(b,a.extend({},{type:"warning",delay:1e4},c))},g.success=function(b){return g.log(b,a.extend({},{type:"success",delay:6e3},c))},g.alert=function(a){alertify.reset().dialogContainerClass("fm-popup").alert(a)},g.confirm=function(a){alertify.reset().dialogWidth(a.width).dialogPersistent(a.persistent).dialogContainerClass("fm-popup").confirm(a.message,a.okBtn,a.cancelBtn)},g.prompt=function(a){alertify.reset().dialogWidth(a.width).dialogPersistent(a.persistent).dialogContainerClass("fm-popup").theme(a.template).prompt(a.message,a.value||"",a.okBtn,a.cancelBtn)},g.dialog=function(a){alertify.reset().dialogWidth(a.width).dialogPersistent(a.persistent).dialogContainerClass("fm-popup").dialog(a.message,a.buttons)},g.setDimensions=function(){var b=0,c=h.outerHeight(!0)-h.height();a.urlParam("CKEditorCleanUpFuncNum")&&(b+=60);var d=a(window).height()-j.height()-m.height()-c-b;l.height(d);var e=a(document).height()-a(window).height();if(!h.parent().is("body")&&e>0){var f=d-e;d=f>0?f:1,l.height(d)}var g=l.width()-l.children(".splitter-bar-vertical").outerWidth()-o.outerWidth();n.width(g)};var D=function(){E().then(function(a,b){return F()}).then(function(){return G()}).then(function(){return H()}).then(function(){I(),J()})},E=function(){return g.settings=a.extend(!0,f,c),a.when(N("default"),N("user")).done(function(b,c){var d=b[0],e=c[0];void 0!==e&&null!==e&&delete e.version,s=a.extend({},d,e),v=s.options.baseUrl===!1?location.origin+location.pathname:s.options.baseUrl,$(v).length>0&&(v=v.substring(0,v.lastIndexOf("/")+1)),v=Y(v)+"/";var f="connectors/"+s.api.lang+"/filemanager."+s.api.lang;w=s.api.connectorUrl||v+f})},F=function(){function b(a){return d+a+".json"}var c=a.urlParam("langCode"),d=g.settings.pluginPath+"/scripts/languages/";return a.ajax().then(function(){return 0!=c?M(b(c)).done(function(){s.options.culture=c}).fail(function(){setTimeout(function(){g.error("Given language file ("+b(c)+") does not exist!")},500)}):void 0}).then(function(){return a.ajax({type:"GET",url:b(s.options.culture),dataType:"json"}).done(function(a){t=a})})},G=function(){return a.ajax({type:"GET",url:g.settings.pluginPath+"/"+s.icons.path+"/",success:function(b){a(b).find("a").attr("href",function(a,b){b.match(/\.(png)$/)&&r.push(b)})}})},H=function(){return a.when(Q("upload-container"),Q("upload-item")).done(function(a,b){var c=a[0],d=b[0];i.append(c).append(d)})},I=function(){O("/themes/"+s.options.theme+"/styles/theme.css"),P("/scripts/zeroclipboard/dist/ZeroClipboard.js"),s.edit.enabled&&(O("/scripts/CodeMirror/lib/codemirror.css"),O("/scripts/CodeMirror/theme/"+s.edit.theme+".css"),P("/scripts/CodeMirror/lib/codemirror.js"),P("/scripts/CodeMirror/addon/selection/active-line.js"),O("/scripts/CodeMirror/addon/display/fullscreen.css"),P("/scripts/CodeMirror/addon/display/fullscreen.js"),P("/scripts/CodeMirror/dynamic-mode.js")),s.customScrollbar.enabled&&(O("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css"),P("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js")),s.options.browseOnly||(P("/scripts/jQuery-File-Upload/js/vendor/jquery.ui.widget.js"),P("/scripts/jQuery-File-Upload/js/canvas-to-blob.min.js"),P("/scripts/jQuery-File-Upload/js/load-image.all.min.js"),P("/scripts/jQuery-File-Upload/js/jquery.iframe-transport.js"),P("/scripts/jQuery-File-Upload/js/jquery.fileupload.js"),P("/scripts/jQuery-File-Upload/js/jquery.fileupload-process.js"),P("/scripts/jQuery-File-Upload/js/jquery.fileupload-image.js"),P("/scripts/jQuery-File-Upload/js/jquery.fileupload-validate.js"),s.upload.multiple&&O("/scripts/jQuery-File-Upload/css/dropzone.css")),s.options.charsLatinOnly&&P("/scripts/speakingurl/speakingurl.min.js")},J=function(){x=s.options.capabilities||["upload","select","download","rename","move","delete","replace"];var b=[];if(s.options.fileSorting&&(b=s.options.fileSorting.toLowerCase().split("_")),y=b[0]||"name",z=b[1]||"asc",A=new K,ko.applyBindings(A),ko.bindingHandlers.toggleNodeVisibility={init:function(b,c){var d=c();a(b).toggle(d.isExpanded())},update:function(b,c){var d=c();return d.isSliding()===!1?!1:(d.isExpanded()===!1&&a(b).slideDown(A.treeList.options.expandSpeed,function(){d.isSliding(!1),d.isExpanded(!0)}),void(d.isExpanded()===!0&&a(b).slideUp(A.treeList.options.expandSpeed,function(){d.isSliding(!1),d.isExpanded(!1)})))}},ko.bindingHandlers.draggableView={init:function(b,c,d){var e=c();"file"!==e.rdo.type&&"folder"!==e.rdo.type||a(b).draggable({distance:3,cursor:"pointer",refreshPositions:!1,helper:function(){var b="drag-helper-"+A.viewMode();return a("<div>",{"class":b}).append(a(this).clone().html())},appendTo:s.customScrollbar.enabled?n.find(".mCustomScrollBox"):n,drag:function(b,c){a(this).draggable("option","refreshPositions",A.itemsList.isScrolling())}})}},ko.bindingHandlers.droppableView={init:function(b,c,d){"folder"!==c().rdo.type&&"parent"!==c().rdo.type||a(b).droppable({hoverClass:"drop-hover",accept:function(a){var b=ko.dataFor(a[0]),c=b?b.rdo.type:null;return"file"===c||"folder"===c},drop:function(a,b){va(ko.dataFor(b.draggable[0]),ko.dataFor(a.target))}})}},ko.bindingHandlers.draggableTree={init:function(b,c,d){var e=c();"file"!==e.rdo.type&&"folder"!==e.rdo.type||a(b).draggable({distance:3,cursor:"pointer",refreshPositions:!1,helper:function(){return a("<li>").append(a(this).clone())},appendTo:s.customScrollbar.enabled?o.find(".mCustomScrollBox"):o,start:function(a,b){},stop:function(a,b){},drag:function(b,c){a(this).draggable("option","refreshPositions",A.treeList.isScrolling())}})}},ko.bindingHandlers.droppableTree={init:function(b,c,d){"folder"!==c().rdo.type&&"parent"!==c().rdo.type||a(b).droppable({hoverClass:"drop-hover",accept:function(b){if(b.closest("ul").prev("a").is(a(this)))return!1;if(a.contains(b.parent()[0],this))return!1;var c=ko.dataFor(b[0]),d=c?c.rdo.type:null;return"file"===d||"folder"===d},drop:function(a,b){va(ko.dataFor(b.draggable[0]),ko.dataFor(a.target))}})}},s.extras.extra_js)for(var c=0;c<s.extras.extra_js.length;c++)a.ajax({type:"GET",url:s.extras.extra_js[c],dataType:"script",async:s.extras.extra_js_async});a("#link-to-project").attr("href",s.url).attr("target","_blank").attr("title",t.support_fm+" ["+t.version+" : "+s.version+"]"),a("div.version").html(s.version),0!=a.urlParam("exclusiveFolder")&&(u+=a.urlParam("exclusiveFolder"),X(u)&&(u+="/"),u=u.replace(/\/\//g,"/"));var d="";0!=a.urlParam("expandedFolder")&&(d=a.urlParam("expandedFolder"),C=u+d,C=C.replace(/\/\//g,"/")),s.options.localizeGUI===!0,a.urlParam("CKEditorCleanUpFuncNum")&&(a("body").append('<button id="close-btn" type="button">'+t.close+"</button>"),a("#close-btn").click(function(){parent.CKEDITOR.tools.callFunction(a.urlParam("CKEditorCleanUpFuncNum"))})),a("#browse").append("+").attr("title",t.browse),a("#newfile").change(function(){a("#filepath").val(a(this).val().replace(/.+[\\\/]/,""))}),s.options.searchBox===!0?P("/scripts/filemanager.liveSearch.min.js"):a("#search").remove(),j.find(".btn-grid").click(function(){A.viewMode("grid"),A.previewFile(!1)}),j.find(".btn-list").click(function(){A.viewMode("list"),A.previewFile(!1)}),a("#summary").click(function(){a.getJSON(ha({mode:"summarize"}),function(b){if(0==b.Code){var c=T(b.Size,!0),d=a("<div>",{"class":"summary-popup"});if(b.SizeLimit>0){var e=T(b.SizeLimit,!0),f=100*b.Size/b.SizeLimit,h=Math.round(100*f)/100;c+=" ("+h+"%) "+t.of+" "+e}d.append(a("<div>",{"class":"title",text:t.summary_title})),d.append(a("<div>",{"class":"line",text:t.summary_files+": "+b.Files})),b.Folders&&d.append(a("<div>",{"class":"line",text:t.summary_folders+": "+b.Folders})),d.append(a("<div>",{"class":"line",text:t.summary_size+": "+c})),g.alert(d[0].outerHTML)}else g.error(b.Error)}).error(function(a){U(a)})}),la(u),s.upload.multiple?(a("#file-input-container").remove(),p.unbind().click(function(){if(-1===x.indexOf("upload"))return g.error(t.NOT_ALLOWED),!1;var b=null,c=A.currentPath(),d=tmpl("tmpl-fileupload-container",{folder:t.current_folder+c,info:t.upload_files_number_limit.replace("%s",s.upload.numberOfFiles)+" "+t.upload_file_size_limit+T(s.upload.fileSizeLimit,!0),lang:t});"DISALLOW_ALL"==s.upload.policy&&(b=new RegExp("(\\.|\\/)("+s.upload.restrictions.join("|")+")$","i")),g.dialog({message:d,width:"auto",buttons:[{type:"ok",label:t.upload,autoClose:!1,click:function(a,b){f.children(".upload-item").length>0?f.find(".button-start").trigger("click"):g.error(t.upload_choose_file)}},{label:t.select,closeOnClick:!1,click:function(b,c){a("#fileupload",e).trigger("click")}},{type:"cancel",label:t.close}]});var e=a(".fm-fileupload-container"),f=a(".dropzone",e),h=a(".dropzone-wrapper",e),i=a("#total-progress",e).children();s.customScrollbar.enabled&&h.mCustomScrollbar({theme:s.customScrollbar.theme,scrollButtons:{enable:s.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onOverflowY:function(){h.find(".mCSB_container").css({"margin-right":h.find(".mCSB_scrollTools").width()})},onOverflowYNone:function(){h.find(".mCSB_container").css({"margin-right":"auto"})}},axis:"y"}),h.on("click",function(b){(b.target===this||a(b.target).parent()[0]===this||b.target===f[0]||a(b.target).parent().hasClass("default-message"))&&a("#fileupload",e).trigger("click")}),f.on("click",".button-start",function(b){var c=a(this),d=c.parent().parent(),e=d.data();e.submit(),c.remove()}),f.on("click",".button-abort",function(b){var c=a(this),d=c.parent().parent(),e=d.data(),f=e.files[0].context;e.abort(),f.find(".error-message").text(t.upload_aborted),f.addClass("aborted")}),f.on("click",".button-resume",function(b){var d=a(this),e=d.parent().parent(),f=e.data(),g=f.files[0];g.chunkUploaded&&a.ajax({type:"GET",url:ha({mode:"getfile",path:c+g.serverName}),dataType:"json",success:function(a){a.data&&(f.uploadedBytes=Number(a.data.attributes.size),f.uploadedBytes||(g.chunkUploaded=void 0)),V(a)},error:U}),a.blueimp.fileupload.prototype.options.add.call(a("#fileupload")[0],b,f),f.submit()}),f.on("click",".button-remove",function(b){var d=a(this),e=d.parent().parent(),f=e.data(),g=f.files[0];g.chunkUploaded&&a.ajax({type:"GET",url:ha({mode:"delete",path:c+g.serverName}),dataType:"json",success:function(a){a.data&&(f.uploadedBytes=Number(a.data.attributes.size),f.uploadedBytes||(g.chunkUploaded=void 0)),V(a)},error:U}),d.closest(".upload-item").remove(),j()}),f.on("click",".button-info",function(b){var c=a(this),d=c.closest(".upload-item");if(d.hasClass("error")){var e=d.find(".error-message");g.error(e.text())}});var j=function(){f.children(".upload-item").length>0?f.addClass("started"):f.removeClass("started")};a("#fileupload",e).fileupload({autoUpload:!1,sequentialUploads:!0,dataType:"json",dropZone:f,maxChunkSize:s.upload.chunkSize,url:ha(),paramName:s.upload.paramName,formData:{mode:"upload",currentpath:c},maxNumberOfFiles:s.upload.numberOfFiles,acceptFileTypes:b,maxFileSize:s.upload.fileSizeLimit,messages:{maxNumberOfFiles:t.upload_files_number_limit.replace("%s",s.upload.numberOfFiles),acceptFileTypes:t.upload_file_type_invalid,maxFileSize:t.upload_file_too_big+" "+t.upload_file_size_limit+T(s.upload.fileSizeLimit,!0)},previewMaxHeight:120,previewMaxWidth:120,previewCrop:!0}).on("fileuploadadd",function(b,c){var d=f.children(".upload-item");a.each(c.files,function(b,e){if(d.length>=s.upload.numberOfFiles)return g.error(t.upload_files_number_limit.replace("%s",s.upload.numberOfFiles),{logClass:"fileuploadadd",unique:!0}),!1;e.formattedSize=T(e.size);var h=a(tmpl("tmpl-upload-item",{file:e,lang:t,imagesPath:g.settings.pluginPath+"/scripts/jQuery-File-Upload/img"}));e.context=h,h.find(".buttons").data(c),h.appendTo(f)}),j()}).on("fileuploadsend",function(b,c){a.each(c.files,function(a,b){var d=b.context;d.removeClass("added aborted error").addClass("process"),b.chunkUploaded&&c.total===c.uploadedBytes&&d.remove()})}).on("fileuploadfail",function(b,c){a.each(c.files,function(a,b){b.error=t.upload_failed;var c=b.context;c.removeClass("added process").addClass("error")})}).on("fileuploaddone",function(b,c){a.each(c.files,function(a,b){var d,e=c.result,f=b.context;e.files&&e.files[a].error&&(d=e.files[a].error),"-1"==e.Code&&e.Error&&(d=e.Error),d?(f.removeClass("added process").addClass("error"),f.find(".error-message").text(d),f.find(".button-start").remove()):f.remove()})}).on("fileuploadalways",function(a,b){var c=f.children(".upload-item");0===c.filter(".added").length&&0===c.filter(".process").length&&(0===c.length&&(alertify.clearDialogs(),s.options.showConfirmation&&g.success(t.upload_successful_files)),c.filter(".error").length&&g.error(t.upload_partially+"<br>"+t.upload_failed_details)),j()}).on("fileuploadprocessalways",function(b,c){a.each(c.files,function(a,b){var c=b.context;"undefined"!=typeof c&&(b.preview&&(c.find(".image").append(b.preview),c.find(".preview").removeClass("file-preview").addClass("image-preview")),b.error&&(c.removeClass("added process").addClass("error"),c.find(".error-message").text(b.error),c.find(".button-start").remove()))})}).on("fileuploadprogress",function(b,c){a.each(c.files,function(a,b){var d=b.context,e=parseInt(c.loaded/c.total*100,10);d.find(".progress-bar").css("width",e+"%")})}).on("fileuploadprogressall",function(a,b){var c=parseInt(b.loaded/b.total*100,10);i.css("width",c+"%")}).on("fileuploadchunkdone",function(b,c){a.each(c.files,function(a,b){b.serverName=c.result.files[a].name,b.chunkUploaded=1})})})):(p.click(function(){if(-1===x.indexOf("upload"))return g.error(t.NOT_ALLOWED),!1;var b=a(this).data();a.isEmptyObject(b)?g.error(t.upload_choose_file):b.submit()}),k.fileupload({autoUpload:!1,dataType:"json",url:ha(),paramName:s.upload.paramName}).on("fileuploadadd",function(a,b){p.data(b)}).on("fileuploadsubmit",function(a,b){b.formData={mode:"upload",currentpath:ma()},p.addClass("loading").prop("disabled",!0),p.children("span").text(t.loading_data)}).on("fileuploadalways",function(b,c){a("#filepath").val(""),p.removeData().removeClass("loading").prop("disabled",!1),p.children("span").text(t.upload);var d,e=c.result;if(e.files&&e.files[0].error&&(d=e.files[0].error),"-1"==e.Code&&e.Error&&(d=e.Error),d)g.error(t.upload_failed+"<br>"+d);else{var f=ma();Ja(f),Ea(f),s.options.showConfirmation&&g.success(t.upload_successful_file)}}).on("fileuploadfail",function(a,b){g.error(t.upload_failed)})),s.customScrollbar.enabled&&(o.mCustomScrollbar({theme:s.customScrollbar.theme,scrollButtons:{enable:s.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onScrollStart:function(){A.treeList.isScrolling(!0)},onScroll:function(){A.treeList.isScrolling(!1)}},axis:"yx"}),n.mCustomScrollbar({theme:s.customScrollbar.theme,scrollButtons:{enable:s.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onScrollStart:function(){A.itemsList.isScrolling(!0)},onScroll:function(){A.itemsList.isScrolling(!1)}},axis:"y",alwaysShowScrollbar:0})),1==s.options.browseOnly&&(a("#file-input-container").remove(),p.remove(),j.find(".btn-newfolder").remove(),a("#toolbar").remove("#rename"));var e=document.documentElement;if(e.setAttribute("data-useragent",navigator.userAgent),s.options.logger){(new Date).getTime()}setTimeout(function(){l.splitter({sizeLeft:s.options.splitterWidth,minLeft:s.options.splitterMinWidth,minRight:200});var b=h.find(".fm-loading-wrap");b.fadeOut(800),a(window).trigger("resize")},200),qa()},K=function(){var b=this;this.config=ko.observable(s),this.lg=ko.observable(t),this.loadingView=ko.observable(!0),this.previewFile=ko.observable(!1),this.viewMode=ko.observable(s.options.defaultViewMode),this.currentPath=ko.observable(u),this.browseOnly=ko.observable(s.options.browseOnly),this.loadItems=function(c){b.loadingView(!0);var d={mode:"getfolder",path:c};a.urlParam("type")&&(d.type=a.urlParam("type")),a.ajax({type:"GET",url:ha(d),dataType:"json",cache:!1,success:function(a){a.data&&(b.currentPath(c),b.itemsList.setList(a.data)),V(a)},error:U})};var c=function(){var c=this;this.rdo=ko.observable({}),this.cdo=ko.observable({}),this.viewer=ko.observable({}),this.editor={enabled:ko.observable(!1),content:ko.observable(""),codeMirror:ko.observable(null)},this.bindToolbar=function(a){d(c.rdo(),a)&&Ga(a,c.rdo())},this.load=function(a){c.rdo(a),c.cdo().sizeFormatted=T(a.attributes.size),c.cdo().dimensions=a.attributes.width?a.attributes.width+"x"+a.attributes.height:null;var d=a.attributes.name,e={type:"image",url:ja(a,!1),options:{}};ba(d)&&1==s.edit.enabled&&(e.type="edit"),ea(d)&&s.audios.showAudioPlayer===!0&&(e.type="audio",e.url=ia(a,!0)),da(d)&&s.videos.showVideoPlayer===!0&&(e.type="video",e.url=ia(a,!0),e.options={width:s.videos.videosPlayerWidth,height:s.videos.videosPlayerHeight}),fa(d)&&s.pdfs.showPdfReader===!0&&(e.type="pdf",e.url=g.settings.pluginPath+"/scripts/ViewerJS/index.html#"+ia(a,!0),e.options={width:s.pdfs.pdfsReaderWidth,height:s.pdfs.pdfsReaderHeight}),ga(d)&&s.docs.showGoogleViewer===!0&&(e.type="google",e.url="http://docs.google.com/viewer?url="+encodeURIComponent(ia(a,!1))+"&embedded=true",e.options={width:s.docs.docsReaderWidth,height:s.docs.docsReaderHeight}),c.viewer(e),b.previewFile(!0),ZeroClipboard.config({swfPath:g.settings.pluginPath+"/scripts/zeroclipboard/dist/ZeroClipboard.swf"});var f=new ZeroClipboard(document.getElementById("copy-button"));f.on("ready",function(a){f.on("aftercopy",function(a){})})},this.copyClipboard=function(){g.success(t.copied)},this.editFile=function(){ya(c.rdo())},this.saveFile=function(){za(c.rdo())},this.closeEditor=function(){c.editor.enabled(!1)},this.buttonVisibility=function(b){switch(b){case"select":return d(c.rdo(),b)&&(a.urlParam("CKEditor")||window.opener||window.tinyMCEPopup||a.urlParam("field_name")||a.urlParam("ImperaviElementId"));case"move":case"rename":case"delete":case"replace":return d(c.rdo(),b)&&s.options.browseOnly!==!0;case"download":return d(c.rdo(),b)}}};this.previewItem=new c;var f=function(){var b=this;this.isScrolling=ko.observable(!1),this.options={showLine:!0,expandSpeed:200},this.treeData={id:"/",level:ko.observable(-1),children:ko.observableArray([])},this.treeData.children.subscribe(function(a){b.arrangeNode(b.treeData)});var c=function(a){if(null!==C){var c=b.findByFilter(function(a){return 0===C.indexOf(a.id)},a);c?(b.options.expandSpeed=10,b.loadNodes(c,!1)):(C=null,b.options.expandSpeed=200)}};this.findByParam=function(a,c,d){if(!d&&(d=b.treeData,d[a]===c))return d;var e=d.children();if(!e||0===e.length)return null;for(var f=0,g=e.length;g>f;f++){if(e[f][a]===c)return e[f];var h=b.findByParam(a,c,e[f]);if(h)return h}return null},this.findByFilter=function(a,c){if(!c&&(c=b.treeData,a(c)))return c;var d=c.children();if(!d||0===d.length)return null;for(var e=0,f=d.length;f>e;e++){if(a(d[e]))return d[e];var g=b.findByFilter(a,d[e]);if(g)return g}return null},this.loadNodes=function(d,e){var f=d?d.id:b.treeData.id;d&&d.isLoading(!0);var g={mode:"getfolder",path:f};a.urlParam("type")&&(g.type=a.urlParam("type")),a.ajax({type:"GET",url:ha(g),dataType:"json",cache:!1,success:function(g){if(g.data){A.currentPath(f),A.itemsList.setList(g.data);var h=[];a.each(g.data,function(a,c){var d=b.createNode(c);h.push(d)}),e&&d.children([]),b.addNodes(d,h),d&&(d.isLoaded(!0),b.expandNode(d)),c(d)}V(g)},error:U})},this.createNode=function(a){return new d(a)},this.addNodes=function(c,d){a.isArray(d)||(d=[d]),c||(c=b.treeData),s.options.listFiles||(d=a.grep(d,function(a){return a.cdo.isFolder})),a.each(d,function(a,b){b.parentNode(c)});var e=c.children().concat(d);c.children(L(e))},this.expandNode=function(a){return a.isExpanded()===!1&&a.isLoaded()===!0?(a.isSliding(!0),!0):!1},this.collapseNode=function(a){return a.isExpanded()===!0?(a.isSliding(!0),!0):!1},this.arrangeNode=function(b){var c=b.children().length;a.each(b.children(),function(a,d){d.level(b.level()+1),d.isFirstNode(0===a),d.isLastNode(a===c-1)})},this.nodeRendered=function(b,c){a(b[1]).contextMenu({selector:".file, .directory",build:function(a,b){return{appendTo:".fm-container",items:e(c.rdo),callback:function(a,b){Ga(a,c.rdo)}}}})},this.actualizeNodeObject=function(c,d,e){var f=new RegExp("^"+d),g=c.rdo.id,h=g.replace(f,e);c.id=h,c.rdo.id=h,c.rdo.attributes.path=c.rdo.attributes.path.replace(new RegExp(g+"$"),h),c.children().length&&a.each(c.children(),function(a,c){b.actualizeNodeObject(c,d,e)})};var d=function(a){var c=this;this.id=a.id,this.rdo=a,this.cdo={isFolder:"folder"===a.type,dimensions:a.attributes.width?a.attributes.width+"x"+a.attributes.height:null,itemClass:"folder"===a.type?"directory":"file"},this.nodeTitle=ko.observable(a.attributes.name),this.children=ko.observableArray([]),this.parentNode=ko.observable(null),this.isSliding=ko.observable(!1),this.isExpanded=ko.observable(!1),this.isLoading=ko.observable(!1),this.isLoaded=ko.observable(!1),this.collapsedOnDrag=ko.observable(!1),this.level=ko.observable(0),this.isFirstNode=ko.observable(!1),this.isLastNode=ko.observable(!1),this.nodeTitle.subscribe(function(a){c.rdo.attributes.name=a}),this.children.subscribe(function(a){b.arrangeNode(c)}),this.isLoaded.subscribe(function(a){a===!0&&c.isLoading(!1)}),this.toggleNode=function(a){return a.cdo.isFolder?a.rdo.attributes["protected"]?(g.error(t.NOT_ALLOWED_SYSTEM),!1):void(a.isExpanded()||a.isLoaded()?a.isSliding(!0):b.loadNodes(a,!0)):!1},this.viewNode=function(a){c.toggleNode(a),"file"===a.rdo.type&&Fa(a.rdo)},this.remove=function(){c.parentNode().children.remove(c)},this.isRoot=function(){return c.level()===b.treeData.id},this.title=ko.pureComputed(function(){return s.options.showTitleAttr?this.rdo.id:null},this),this.iconClass=ko.pureComputed(function(){var a,b=["ico"];return this.cdo.isFolder===!0?(a="ico_folder",this.isLoading()===!0?b.push("loading"):(b.push("folder"),this.rdo.attributes["protected"]?b.push("lock"):(this.isExpanded()||!this.isExpanded()&&this.isSliding())&&b.push("open"))):(a="ico_file",this.rdo.attributes["protected"]?b.push("file","lock"):b.push("ext",this.rdo.attributes.extension)),a+" "+b.join("_")},this),this.switcherClass=ko.pureComputed(function(){var a=[];if(b.options.showLine?0===this.level()&&this.isFirstNode()&&this.isLastNode()?a.push("root"):0==this.level()&&this.isFirstNode()?a.push("roots"):this.isLastNode()?a.push("bottom"):a.push("center"):a.push("noline"),this.cdo.isFolder){var c=this.isExpanded()||!this.isExpanded()&&this.isSliding();a.push(c?"open":"close")}else a.push("docu");return a.join("_")},this),this.clusterClass=ko.pureComputed(function(){return b.options.showLine&&!this.isLastNode()?"line":""},this)}};this.treeList=new f;var h=function(){var c=this;this.imageMaxWidth=64,this.listSortField=ko.observable(y),this.listSortOrder=ko.observable(z),this.isScrolling=ko.observable(!1),this.objects=ko.observableArray([]),this.createObject=function(a){return new f(a)},this.addNew=function(d){a.isArray(d)||(d=[d]),a.each(d,function(a,d){b.itemsList.objects.push(c.createObject(d))}),b.itemsList.sortObjects()},this.setList=function(d){var e=[];if(!X(b.currentPath())&&b.currentPath()!==u){var f=aa(b.currentPath()),h={id:f,rdo:{type:"parent"},cdo:{imageUrl:g.settings.pluginPath+"/"+s.icons.path+"/"+s.icons.parent}};h.open=function(){b.loadItems(h.id)},e.push(h)}a.each(d,function(a,b){e.push(c.createObject(b))}),b.itemsList.objects(e),b.itemsList.sortObjects(),b.loadingView(!1)},this.findByParam=function(a,b){return ko.utils.arrayFirst(A.itemsList.objects(),function(c){return c[a]===b})},this.sortObjects=function(){var a=L(c.objects());c.objects(a)},this.objects.subscribe(function(a){n.contextMenu({selector:".file, .directory",build:function(a,b){var c=ko.dataFor(a[0]);return{appendTo:".fm-container",items:e(c.rdo),callback:function(a,b){Ga(a,c.rdo)}}}})});var f=function(a){var b=c.imageMaxWidth;a.attributes.width&&a.attributes.width<c.imageMaxWidth&&(b=a.attributes.width),this.id=a.id,this.rdo=a,this.cdo={isFolder:"folder"===a.type,sizeFormatted:T(a.attributes.size),dimensions:a.attributes.width?a.attributes.width+"x"+a.attributes.height:null,itemClass:"folder"===a.type?"directory":"file",imageUrl:ja(a,!0),previewWidth:b},this.title=ko.pureComputed(function(){return s.options.showTitleAttr?this.rdo.id:null},this),this.listIconClass=ko.pureComputed(function(){var a,b=["ico"];return this.cdo.isFolder===!0?(a="ico_folder",b.push("folder"),this.rdo.attributes["protected"]&&b.push("lock")):(a="ico_file",this.rdo.attributes["protected"]?b.push("file","lock"):b.push("ext",this.rdo.attributes.extension)),a+" "+b.join("_")},this),this.open=function(){var a=this;s.options.quickSelect&&"file"===a.rdo.type&&d(a.rdo,"select")?ra(a.rdo):Fa(a.rdo)},this.remove=function(){c.objects.remove(this)}}};this.itemsList=new h;var i=function(){var a=function(a){var c=this;this.column=ko.observable(a),this.order=ko.observable(b.itemsList.listSortOrder()),this.sortClass=ko.pureComputed(function(){var a;return b.itemsList.listSortField()===c.column()&&(a="sorted sorted-"+this.order()),a},this),this.sort=function(){var a="asc"===c.order(),d=b.itemsList.listSortField()===c.column();c.order(d?a?"desc":"asc":b.itemsList.listSortOrder()),b.itemsList.listSortField(c.column()),b.itemsList.listSortOrder(c.order()),b.itemsList.sortObjects()}};this.thName=new a("name"),this.thType=new a("type"),this.thSize=new a("size"),this.thDimensions=new a("dimensions"),this.thModified=new a("modified")};this.tableView=new i;var j=function(){this.goHome=function(){b.previewFile(!1),b.loadItems(u)},this.goParent=function(){return b.currentPath()!==u||b.previewFile()?void(b.previewFile()?b.previewFile(!1):b.loadItems(aa(A.currentPath()))):!1},this.createFolder=function(){var b=function(b,c){var d=c.getInputValue();return d?(d=R(d),void a.ajax({type:"GET",url:ha({mode:"addfolder",path:A.currentPath(),name:d}),dataType:"json",success:function(a){if(a.data){var b=A.treeList.findByParam("id",A.currentPath());if(b){var d=A.treeList.createNode(a.data);A.treeList.addNodes(b,d)}A.itemsList.addNew(a.data),c.closeDialog(),s.options.showConfirmation&&g.success(t.successful_added_folder)}V(a)},error:U})):void g.error(t.no_foldername)};g.prompt({message:t.prompt_foldername,value:t.default_foldername,okBtn:{label:t.create_folder,autoClose:!1,click:b},cancelBtn:{label:t.cancel}})}};this.header=new j},L=function(a){function b(a){var b,c=y;switch("list"===A.viewMode()&&(c=A.itemsList.listSortField()),c){case"type":b=a.rdo.attributes.extension||"";break;case"size":b=a.rdo.attributes.size;break;case"modified":b=a.rdo.attributes.timestamp;break;case"dimensions":b=a.cdo.dimensions||"";break;default:b=a.rdo.attributes.name}return"string"==typeof b&&(f.cases||(b=b.toLowerCase()),b=b.replace(/\s+/g," ")),b}function c(a,b){for(var c=d(a.toString()),e=d(b.toString()),f=0;c[f]&&e[f];f++)if(c[f]!==e[f]){var g=Number(c[f]),h=Number(e[f]);return g==c[f]&&h==e[f]?g-h:c[f]>e[f]?1:-1}return c.length-e.length}function d(a){for(var b,c,d=[],e=0,f=-1,g=0;b=(c=a.charAt(e++)).charCodeAt(0);){var h=46==b||b>=48&&57>=b;h!==g&&(d[++f]="",g=h),d[f]+=c}return d}var e="list"===A.viewMode()?A.itemsList.listSortOrder():z,f={natural:!0,order:"asc"===e?1:-1,cases:!1};a.sort(function(a,d){if("parent"===a.rdo.type||"parent"===d.rdo.type)return-1;var e,g=b(a),h=b(d);return e=g===h?0:void 0===g||void 0===h?0:f.natural&&(isNaN(g)||isNaN(h))?c(g,h):h>g?-1:g>h?1:0,e*=f.order});for(var g=[],h=a.length;h--;)"folder"===a[h].rdo.type&&(g.push(a[h]),a.splice(h,1));"top"!==s.options.folderPosition&&g.reverse();for(var i=0,j=g.length;j>i;i++)"top"===s.options.folderPosition?a.unshift(g[i]):a.push(g[i]);return a},M=function(b){return a.ajax({type:"HEAD",url:b})},N=function(b){var c=null;return b="undefined"==typeof b?"user":b,"user"===b?0!=a.urlParam("config")?(c=g.settings.pluginPath+"/scripts/"+a.urlParam("config"),B=a.urlParam("config")):(c=g.settings.pluginPath+"/scripts/filemanager.config.json",B="filemanager.config.json"):c=g.settings.pluginPath+"/scripts/filemanager.config.default.json",a.ajax({type:"GET",url:c,dataType:"json",cache:!1,error:function(a){g.error("Given config file ("+c+") does not exist!")}})},O=function(b){return b=g.settings.pluginPath+b,-1===a.inArray(b,q)&&(a("<link>").attr({rel:"stylesheet",type:"text/css",href:b}).appendTo("head"),q.push(b)),null},P=function(b){b=g.settings.pluginPath+b,-1===a.inArray(b,q)&&(a("<script>").attr({type:"text/javascript",src:b}).appendTo("head"),q.push(b))},Q=function(b,c){return a.ajax({type:"GET",url:g.settings.pluginPath+"/scripts/templates/"+b+".html",error:U})},R=function(a,b){if(s.security.normalizeFilename){var c={" ":"_","'":"_","/":"","\\":""};a=a.replace(/[\s\S]/g,function(a){return c[a]||a})}return s.options.charsLatinOnly&&("undefined"==typeof b&&(b=[]),a=getSlug(a,{separator:"_",maintainCase:!0,custom:b}),a=a.replace(/[^_a-zA-Z0-9]/g,"")),a=a.replace(/[_]+/g,"_")},S=function(a){var b="";return-1!=a.lastIndexOf(".")?(b=R(a.substr(0,a.lastIndexOf("."))),b+="."+a.split(".").pop()):b=R(a),b},T=function(a,b){if(!a)return"";b=b||!1;for(var c=parseFloat(a),d=parseFloat(b?1e3:1024),e=0,f=[t.bytes,t.kb,t.mb,t.gb];;){if(d>c)return c=Math.round(100*c)/100,c+" "+f[e];c/=d,e+=1}},U=function(a){s.options.logger,g.error(t.ERROR_SERVER),g.error(a.responseText)},V=function(b){b.errors&&a.each(b.errors,function(a,b){g.error(b)})},W=function(b){var c=$(b);return""===c&&s.security.allowNoExtension===!0?!0:"DISALLOW_ALL"==s.upload.policy&&-1!==a.inArray(c,s.upload.restrictions)?!0:"ALLOW_ALL"==s.upload.policy&&-1===a.inArray(c,s.upload.restrictions)},X=function(a){return"/"!==a.charAt(a.length-1)},Y=function(a){return a.replace(/^\/+|\/+$/g,"")},Z=function(b){var c=[];return a.each(b.split("/"),function(a,b){c.push(encodeURIComponent(b))}),c.join("/")},$=function(a){return 1===a.split(".").length?"":a.split(".").pop().toLowerCase()},_=function(a){return-1!==a.lastIndexOf(".")?a.substring(0,a.lastIndexOf(".")):a},aa=function(a){return a.split("/").reverse().slice(2).reverse().join("/")+"/"},ba=function(b){return-1!==a.inArray($(b),s.edit.editExt);
},ca=function(b){return-1!==a.inArray($(b),s.images.imagesExt)},da=function(b){return-1!==a.inArray($(b),s.videos.videosExt)},ea=function(b){return-1!==a.inArray($(b),s.audios.audiosExt)},fa=function(b){return-1!==a.inArray($(b),s.pdfs.pdfsExt)},ga=function(b){return-1!==a.inArray($(b),s.docs.docsExt)},ha=function(b){var c={config:B,time:(new Date).getTime()},d=a.extend({},b||{},c);return w+"?"+a.param(d)},ia=function(a,b){b=b||!1;var c=a.attributes.path;return s.preview.absolutePath&&c?(b&&(c=Z(c)),ka(c)):ha({mode:"readfile",path:a.id})},ja=function(a,b){var c,d=g.settings.pluginPath+"/"+s.icons.path;if(X(a.id))if(1==a.attributes["protected"])c=d+"locked_"+s.icons["default"];else{var e=$(a.id),f=ca(a.id),h=e+".png";if(c=d+s.icons["default"],f&&s.images.showThumbs||-1===r.indexOf(h)||(c=d+h),f)if(s.preview.absolutePath&&!b&&a.attributes.path)c=ka(Z(a.attributes.path));else{var i={path:a.id};"svg"===e?i.mode="readfile":(i.mode="getimage",b&&(i.thumbnail="true")),c=ha(i)}}else c=d+(1==a.attributes["protected"]?"locked_":"")+s.icons.folder;return c},ka=function(a){var b="string"==typeof s.preview.previewUrl?s.preview.previewUrl:v;return Y(b)+a},la=function(a){},ma=function(){var a=j.find(".current-path");return a.find("input:hidden").val()},na=function(a){return s.customScrollbar.enabled?a.find(".mCSB_container"):a},oa=function(){var b,c="grid"==n.data("view"),d=c?"li":"tbody > tr",e=0;b=n.find(d+".file, "+d+".directory").not(".ui-draggable-dragging").length,n.find(d+".file").not(".ui-draggable-dragging").each(function(){var b=a(this).data("itemdata");e+=Number(b.Properties.Size)}),a("#items-counter").text(b+" "+t.items),a("#items-size").text(t.size+": "+T(e))},pa=function(b){1==s.options.searchBox&&(a("#q").liveUpdate("#filetree ul").blur(),a("#search span.q-inactive").html(t.search),a("#search a.q-reset").attr("title",t.search_reset)),b.find("li.file, li.directory").draggable({distance:10,cursor:"move",helper:function(){var b=a(this).clone();return b.find("ul").remove(),b}}),b.find("li.directory > a").droppable({accept:function(b){return b.is("li.file, li.directory")&&!b.parent().prev("a").is(a(this))},hoverClass:"drop-hover",drop:function(b,c){var d=c.draggable.find("a").attr("data-path"),e=a(b.target).attr("data-path");va(d,e)}})},qa=function(){return void A.treeList.loadNodes(null,!1)},ra=function(b){var c=ia(b,!0);if(window.opener||window.tinyMCEPopup||a.urlParam("field_name")||a.urlParam("CKEditorCleanUpFuncNum")||a.urlParam("CKEditor")||a.urlParam("ImperaviElementId")){if(window.tinyMCEPopup){var d=tinyMCEPopup.getWindowArg("window");return d.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=c,"undefined"!=typeof d.ImageDialog&&(d.ImageDialog.getImageData&&d.ImageDialog.getImageData(),d.ImageDialog.showPreviewImage&&d.ImageDialog.showPreviewImage(c)),void tinyMCEPopup.close()}if(a.urlParam("field_name"))parent.document.getElementById(a.urlParam("field_name")).value=c,"undefined"!=typeof parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),"undefined"!=typeof parent.$.fn.colorbox&&parent.$.fn.colorbox.close();else if(a.urlParam("ImperaviElementId"))if(window.opener);else{var e=a.urlParam("ImperaviElementId"),f=parent.$("#"+e).redactor("core.getObject");f&&(f.modal.close(),f.buffer.set(),ca(b.attributes.name)?f.insert.html('<img src="'+c+'">'):f.insert.html('<a href="'+c+'">'+b.attributes.name+"</a>"))}else if(a.urlParam("CKEditor"))window.opener?window.opener.CKEDITOR.tools.callFunction(a.urlParam("CKEditorFuncNum"),c):(parent.CKEDITOR.tools.callFunction(a.urlParam("CKEditorFuncNum"),c),parent.CKEDITOR.tools.callFunction(a.urlParam("CKEditorCleanUpFuncNum")));else if(b.attributes.width){var h=c,i=b.attributes.width,j=b.attributes.height;window.opener.SetUrl(h,i,j)}else window.opener.SetUrl(c);window.opener&&window.close()}else g.error(t.fck_select_integration)},sa=function(b){var c=function(c,d){var e=b.id,f=d.getInputValue();if(!f)return void g.error(t.new_filename);if(!s.security.allowChangeExtensions){f=S(f);var h=$(b.attributes.name);h.length>0&&(f=f+"."+h)}if(X(e)&&!W(f)){var i="<p>"+t.INVALID_FILE_TYPE+"</p>";return"DISALLOW_ALL"==s.upload.policy&&(i+="<p>"+t.ALLOWED_FILE_TYPE+s.upload.restrictions.join(", ")+".</p>"),"ALLOW_ALL"==s.upload.policy&&(i+="<p>"+t.DISALLOWED_FILE_TYPE+s.upload.restrictions.join(", ")+".</p>"),a("#filepath").val(""),void g.error(i)}a.ajax({type:"GET",url:ha({mode:"rename",old:e,"new":f}),dataType:"json",success:function(a){if(a.data){var b=a.data,c=A.treeList.findByParam("id",e);if(c&&("folder"===c.rdo.type&&(c.nodeTitle(b.attributes.name),A.treeList.actualizeNodeObject(c,e,b.id)),"file"===c.rdo.type)){var f=c.parentNode(),h=A.treeList.createNode(b);c.remove(),f&&A.treeList.addNodes(f,h)}var i=A.itemsList.findByParam("id",e);i&&(i.remove(),A.itemsList.addNew(b)),A.currentPath()===e&&A.loadItems(b.id),A.previewFile()&&A.previewItem.rdo().id===e&&A.previewItem.load(b),d.closeDialog(),s.options.showConfirmation&&g.success(t.successful_rename)}else g.error(result.Error)},error:U})};g.prompt({message:t.new_filename,value:s.security.allowChangeExtensions?b.attributes.name:_(b.attributes.name),okBtn:{label:t.rename,autoClose:!1,click:c},cancelBtn:{label:t.cancel}})},ta=function(b){var c=a("#toolbar"),d=c.find("#replacement");"undefined"==typeof c.data("blueimpFileupload")&&c.fileupload({autoUpload:!0,dataType:"json",url:ha(),paramName:s.upload.paramName}).on("fileuploadadd",function(a,c){var d=c.files[0];return $(d.name)!=b.rdo.attributes.extension?(g.error(t.ERROR_REPLACING_FILE+" ."+b.rdo.attributes.extension),!1):void c.submit()}).on("fileuploadsubmit",function(a,c){c.formData={mode:"replace",newfilepath:b.id},p.addClass("loading").prop("disabled",!0),p.children("span").text(t.loading_data)}).on("fileuploadalways",function(b,c){p.removeData().removeClass("loading").prop("disabled",!1),p.children("span").text(t.upload);var d,e=c.result;if(e.files&&e.files[0].error&&(d=e.files[0].error),"-1"==e.Code&&e.Error&&(d=e.Error),d)g.error(t.upload_failed+"<br>"+d);else{var f=n.find("#main-title > h1").attr("title"),h=ma();Ha(f),Ea(h),a("#preview").find("img").hide().fadeIn("slow"),o.find('a[data-path="'+f+'"]').parent().hide().fadeIn("slow"),s.options.showConfirmation&&g.success(t.successful_replace)}}).on("fileuploadfail",function(a,b){g.error(t.upload_failed)}),d.click()},ua=function(a){var b=function(b,c){var d=c.getInputValue();return d?void va(a.Path,d):void g.error(t.prompt_foldername)};g.prompt({message:t.move,value:s.security.allowChangeExtensions?a.Filename:_(a.Filename),okBtn:{label:t.move,autoClose:!1,click:b},cancelBtn:{label:t.cancel},template:{dialogInput:'<input data-alertify-input type="text" value="" /><div class="prompt-info">'+t.help_move+"</div>"}})},va=function(b,c){var d=b.id,e=c.id;a.ajax({type:"GET",url:ha({mode:"move",old:d,"new":e}),dataType:"json",success:function(a){if(a.data){var d=a.data,e=A.treeList.findByParam("id",b.id),f=A.treeList.findByParam("id",c.id);if(e&&e.remove(),f){var h=A.treeList.createNode(d);A.treeList.addNodes(f,h)}var i=A.itemsList.findByParam("id",b.id);i&&i.remove(),A.currentPath()===c.id&&A.itemsList.addNew(d),A.currentPath()===b.id&&A.loadItems(d.id),A.previewFile()&&A.previewItem.rdo().id===b.id&&A.previewFile(!1),alertify.clearDialogs(),s.options.showConfirmation&&g.success(t.successful_moved)}V(a)},error:U})},wa=function(b){var c=function(c,d){a.ajax({type:"GET",url:ha({mode:"delete",path:b.id}),dataType:"json",success:function(a){if(a.data){var b=a.data.id,c=A.treeList.findByParam("id",b);c&&c.remove();var d=A.itemsList.findByParam("id",b);d&&d.remove(),A.previewFile()&&A.previewItem.rdo().id===b&&A.previewFile(!1),s.options.showConfirmation&&g.success(t.successful_delete)}V(a)},error:U})};g.confirm({message:t.confirmation_delete,okBtn:{label:t.yes,click:c},cancelBtn:{label:t.no}})},xa=function(b){var c={mode:"download",path:b.id};a.ajax({type:"GET",url:ha(c),dataType:"json",success:function(a){a.data.attributes.success&&(window.location=ha(c)),V(a)},error:U})},ya=function(b){a.ajax({type:"GET",url:ha({mode:"editfile",path:b.id}),dataType:"json",success:function(a){if(a.data){A.previewItem.editor.enabled(!0),A.previewItem.editor.content(a.data.attributes.content);var c=instantiateCodeMirror($(b.id),s,P);A.previewItem.editor.codeMirror(c)}V(a)},error:U})},za=function(b){var c=A.previewItem.editor.codeMirror().getValue();A.previewItem.editor.content(c),a.ajax({type:"POST",url:ha(),dataType:"json",data:a("#edit-form").serializeArray(),success:function(a){a.data&&(A.previewItem.editor.enabled(!1),g.success(t.successful_edit)),V(a)},error:U})},Aa=function(b){var c=y,d=a(b).data("itemdata");if("list"==n.data("view")){var e=n.data("list-sort");e&&(c=e.column)}switch(c){case"type":return d["File Type"];case"size":return d.Properties.Size;case"modified":return d.Properties.filemtime;case"dimensions":return d.Properties.Width+"x"+d.Properties.Height;default:return d.Filename}},Ba=function(a,b){"bottom"===s.options.folderPosition&&a.find(b+".directory").appendTo(a),"top"===s.options.folderPosition&&(a.find(b+".directory").prependTo(a),a.find(b+".directory-parent").prependTo(a))},Ca=function(a){var b=a.find("> li");0!==b.length&&(b.tsort({selector:"a",callback:Aa,order:z,natural:!0}),Ba(a,"> li"))},Da=function(){var a,b=n.find("#contents");if("grid"==n.data("view")){if(a=b.find("li.file, li.directory"),0===a.length)return;a.tsort({callback:Aa,order:z,natural:!0}),Ba(b,"li")}else{var c,d,e,f=n.data("list-sort"),g=b.find("th");if(d=f?f.order:z,c=f?f.column:y,e=g.filter(".column-"+c),g.removeClass("sorted sorted-asc sorted-desc"),e.addClass("sorted sorted-"+d),a=b.find("tr.file, tr.directory"),0===a.length)return;a.tsort({callback:Aa,order:d,natural:!0}),Ba(b,"tr")}},Ea=function(b){var c,d=b===u;if(c=d?na(o).children("ul"):o.find('a[data-path="'+b+'"]').next("ul"),d||c.parent().hasClass("expanded")){var e=buildFileTreeBranch({dir:b}),f=c.find(">li>a").map(function(){return this.getAttribute("data-path")}).get();e.find(">li>a").each(function(){-1===f.indexOf(a(this).attr("data-path"))&&c.append(a(this).parent())}),Ca(c),pa(c)}else na(o).data("fileTree").options.expandSpeed=0,c.prev("a").click()},Fa=function(a){return a.attributes["protected"]?(g.error(t.NOT_ALLOWED_SYSTEM),!1):("file"===a.type&&A.previewItem.load(a),void("folder"!==a.type&&"parent"!==a.type||A.loadItems(a.id)))},Ga=function(a,b){switch(a){case"select":ra(b);break;case"download":xa(b);break;case"rename":sa(b);break;case"replace":ta(b);break;case"move":ua(b);break;case"delete":wa(b)}},Ha=function(b){a(".context-menu-root").hide();var c=b.substr(0,b.lastIndexOf("/")+1);la(c),a.getJSON(ha({mode:"getfile",path:b}),function(c){if("-1"==c.Code)return void handleError(c.Error);var d='<div id="preview"><img /><div id="main-title"><h1></h1><div id="tools"></div></div><dl></dl></div>';d+='<form id="toolbar">',d+='<button id="parentfolder" type="button">'+t.parentfolder+"</button>",-1!=a.inArray("select",x)&&(a.urlParam("CKEditor")||window.opener||window.tinyMCEPopup||a.urlParam("field_name")||a.urlParam("ImperaviElementId"))&&(d+='<button id="select" name="select" type="button">'+t.select+"</button>"),-1!=a.inArray("download",x)&&(d+='<button id="download" name="download" type="button">'+t.download+"</button>"),-1!=a.inArray("rename",x)&&1!=s.options.browseOnly&&(d+='<button id="rename" name="rename" type="button">'+t.rename+"</button>"),-1!=a.inArray("move",x)&&1!=s.options.browseOnly&&(d+='<button id="move" name="move" type="button">'+t.move+"</button>"),-1!=a.inArray("delete",x)&&1!=s.options.browseOnly&&(d+='<button id="delete" name="delete" type="button">'+t.del+"</button>"),-1!=a.inArray("replace",x)&&1!=s.options.browseOnly&&(d+='<button id="replace" name="replace" type="button">'+t.replace+"</button>",d+='<div class="hidden-file-input"><input id="replacement" name="replacement" type="file" /></div>'),d+="</form>",na(n).html(d),n.find("img").attr("src",ja(c)),n.find("#main-title > h1").text(c.Filename).attr("title",b),da(c.Filename)&&1==s.videos.showVideoPlayer&&getVideoPlayer(c),ea(c.Filename)&&1==s.audios.showAudioPlayer&&getAudioPlayer(c),fa(c.Filename)&&1==s.pdfs.showPdfReader&&getPdfReader(c),ga(c.Filename)&&1==s.docs.showGoogleViewer&&getGoogleViewer(c),ba(c.Filename)&&1==s.edit.enabled&&0==c.Protected&&ya(c),0==c.Protected&&(n.find("div#tools").append('<a id="copy-button" data-clipboard-text="'+ia(c)+'" title="'+t.copy_to_clipboard+'" href="#"><span>'+t.copy_to_clipboard+"</span></a>"),a("#copy-button").click(function(){n.find("div#tools").append('<span id="copied">'+t.copied+"</span>"),a("#copied").delay(500).fadeOut(1e3,function(){a(this).remove()})}));var e="";0==c.Protected&&(c.Properties.Width&&""!=c.Properties.Width&&(e+="<dt>"+t.dimensions+"</dt><dd>"+c.Properties.Width+"x"+c.Properties.Height+"</dd>"),c.Properties["Date Created"]&&""!=c.Properties["Date Created"]&&(e+="<dt>"+t.created+"</dt><dd>"+c.Properties["Date Created"]+"</dd>"),c.Properties["Date Modified"]&&""!=c.Properties["Date Modified"]&&(e+="<dt>"+t.modified+"</dt><dd>"+c.Properties["Date Modified"]+"</dd>"),(c.Properties.Size||0==parseInt(c.Properties.Size))&&(e+="<dt>"+t.size+"</dt><dd>"+T(c.Properties.Size)+"</dd>")),n.find("dl").html(e),a("#toolbar").data("fmitem",c)})},Ia=function(b){var c=a.extend({},b);return delete c.Error,delete c.Code,c},Ja=function(b){la(b);var c,f,h,i,j=na(n),k="",l=getFolderData(b);if("-1"==l.Code)return void handleError(l.Error);if(l)if("grid"==n.data("view")){var m=a("<ul>",{id:"contents","class":"grid"});X(b)||b===u||(h='<li class="directory-parent" data-path="'+aa(b)+'" oncontextmenu="return false;">',h+='<div class="clip"><img src="'+g.settings.pluginPath+"/"+s.icons.path+"/"+s.icons.parent+'" alt="Parent" /></div>',h+="</li>",m.append(h));for(var o in l){c=l[o],i=c.Properties;var p=64,q=i.Width;q>1&&p>q&&(p=q);var r=a("<li>",{"class":"dir"==c["File Type"]?"directory":"file",title:s.options.showTitleAttr?c.Path:null,"data-path":c.Path}).data("itemdata",Ia(c));f='<div class="clip"><img src="'+ja(c,!0)+'" width="'+p+'" alt="'+c.Path+'" /></div>',f+="<p>"+c.Filename+"</p>",i.Width&&""!=i.Width&&(f+='<span class="meta dimensions">'+i.Width+"x"+i.Height+"</span>"),i.Size&&""!=i.Size&&(f+='<span class="meta size">'+i.Size+"</span>"),i["Date Created"]&&""!=i["Date Created"]&&(f+='<span class="meta created">'+i["Date Created"]+"</span>"),i["Date Modified"]&&""!=i["Date Modified"]&&(f+='<span class="meta modified">'+i["Date Modified"]+"</span>"),m.append(r.append(f))}k=m}else{var v=a("<table>",{id:"contents","class":"list"}),w='<thead><tr class="rowHeader">';w+='<th class="column-name" data-colname="name"><span>'+t.name+"</span></th>",w+='<th class="column-type" data-colname="type"><span>'+t.type+"</span></th>",w+='<th class="column-dimensions" data-colname="dimensions"><span>'+t.dimensions+"</span></th>",w+='<th class="column-size" data-colname="size"><span>'+t.size+"</span></th>",w+='<th class="column-modified" data-colname="modified"><span>'+t.modified+"</span></th>",w+="</tr></thead>",v.append(w),v.append("<tbody>"),X(b)||b===u||(h='<tr class="directory-parent" data-path="'+aa(b)+'" oncontextmenu="return false;">',h+="<td>..</td>",h+="<td></td>",h+="<td></td>",h+="<td></td>",h+="<td></td>",h+="</tr>",v.append(h));for(var o in l){c=l[o],i=c.Properties;var x=a("<tr>",{"class":"dir"==c["File Type"]?"directory":"file",title:s.options.showTitleAttr?c.Path:null,"data-path":c.Path}).data("itemdata",Ia(c));if(f="<td>"+c.Filename+"</td>",f+=c["File Type"]&&""!=c["File Type"]&&"dir"!=c["File Type"]?"<td>"+c["File Type"]+"</td>":"<td></td>",i.Width&&""!=i.Width){var y=i.Width+"x"+i.Height;f+="<td>"+y+"</td>"}else f+="<td></td>";f+=i.Size&&""!=i.Size?"<td>"+T(i.Size)+"</td>":"<td></td>",f+=i["Date Modified"]&&""!=i["Date Modified"]?"<td>"+i["Date Modified"]+"</td>":"<td></td>",v.append(x.append(f))}v.append("</tbody>"),k=v}else k+="<h1>"+t.could_not_retrieve_folder+"</h1>";j.html(k),Da(),oa();var z=n.find("#contents");"grid"==n.data("view")?(z.contextMenu({selector:"li.file, li.directory",build:function(a,b){return{appendTo:".fm-container",items:e(a),callback:function(a,b){var c=b.$trigger.attr("data-path");setMenus(a,c)}}}}),z.find("li.file, li.directory").draggable({distance:10,cursor:"move",helper:"clone"}),z.find("li.directory-parent, li.directory").droppable({accept:"li.file, li.directory",hoverClass:"drop-hover",drop:function(b,c){var d=c.draggable.attr("data-path"),e=a(b.target).attr("data-path");va(d,e)}}),z.find("li").click(function(){var b=a(this).attr("data-path");s.options.quickSelect&&"dir"!=l[b]["File Type"]&&d(l[b],"select")?ra(l[b]):Fa(b)})):(z.contextMenu({selector:"tr.file, tr.directory",build:function(a,b){return{appendTo:".fm-container",items:e(a),callback:function(a,b){var c=b.$trigger.attr("data-path");setMenus(a,c)}}}}),z.find("tr.file, tr.directory").draggable({distance:10,cursor:"move",helper:"clone"}),z.find("tr.directory-parent, tr.directory").droppable({accept:"tr.file, tr.directory",hoverClass:"drop-hover",drop:function(b,c){var d=c.draggable.attr("data-path"),e=a(b.target).attr("data-path");va(d,e)}}),z.find("tbody > tr").click(function(){var b=a(this).attr("data-path");s.options.quickSelect&&"dir"!=l[b]["File Type"]&&d(l[b],"select")?ra(l[b]):Fa(b)}),z.find(".rowHeader > th").click(function(b){var c=a(this),d=c.data("colname"),e=!c.hasClass("sorted-desc"),f=e?"desc":"asc";n.data("list-sort",{column:d,order:f}),Da()}))};D(),a(window).resize(g.setDimensions)}}(jQuery),$.fn.richFm=function(a){return this.each(function(){if(void 0==$(this).data("richFm")){var b=new $.richFmPlugin(this,a);$(this).data("richFm",b)}})},window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),$(window).load(function(){$(".fm-container").richFm()});